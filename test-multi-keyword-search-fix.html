<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>多关键词搜索修复测试</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .test-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .keywords-display {
      display: flex;
      gap: 5px;
      margin: 10px 0;
    }
    .keyword-tag {
      padding: 4px 8px;
      background-color: #e3f2fd;
      color: #1976d2;
      border-radius: 4px;
      font-size: 14px;
    }
    input, select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #45a049;
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
    }
    .result-box {
      padding: 15px;
      background-color: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    .result-header {
      font-weight: bold;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .result-count {
      font-size: 14px;
      color: #666;
      font-weight: normal;
    }
    .question-item {
      padding: 8px;
      margin-bottom: 6px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 13px;
    }
    .question-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
      font-size: 12px;
      color: #666;
    }
    .question-text {
      font-size: 12px;
      line-height: 1.4;
      max-height: 40px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .highlight {
      background-color: #ffeb3b;
      padding: 1px 2px;
      border-radius: 2px;
    }
    .highlight-alt {
      background-color: #b3e5fc;
      padding: 1px 2px;
      border-radius: 2px;
    }
    .status {
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 4px;
      font-size: 14px;
    }
    .status.info {
      background-color: #e3f2fd;
      color: #1976d2;
    }
    .status.success {
      background-color: #e8f5e9;
      color: #388e3c;
    }
    .status.error {
      background-color: #ffebee;
      color: #d32f2f;
    }
    .comparison {
      margin-top: 20px;
      padding: 15px;
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 4px;
    }
    .loading {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    .match-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-left: 5px;
    }
    .match-single { background-color: #4caf50; }
    .match-multi { background-color: #ff9800; }
    .match-all { background-color: #2196f3; }
  </style>
</head>
<body>
  <h1>多关键词搜索修复测试</h1>
  
  <div class="container">
    <h2>测试说明</h2>
    <p>此测试页面用于验证多关键词搜索的并集功能是否正常工作。</p>
    <ul>
      <li>🟢 单关键词匹配 - 题目只匹配一个关键词</li>
      <li>🟠 多关键词匹配 - 题目匹配多个关键词（优先显示）</li>
      <li>🔵 全部匹配 - 题目匹配所有关键词</li>
    </ul>
  </div>

  <div class="test-section">
    <div class="test-header">
      <div>
        <h3>多关键词并集搜索测试</h3>
        <div class="keywords-display" id="keywords-display"></div>
      </div>
      <div class="test-controls">
        <select id="subject">
          <option value="all">全部科目</option>
          <option value="民法">民法</option>
          <option value="刑法" selected>刑法</option>
          <option value="行政法">行政法</option>
        </select>
        <input type="text" id="keywords" placeholder="输入关键词，逗号分隔" value="盗窃,抢劫" style="width: 200px;">
        <button onclick="runTest()">开始测试</button>
      </div>
    </div>

    <div id="status" class="status info">准备就绪</div>

    <div class="results-grid">
      <div class="result-box">
        <div class="result-header">
          <span>关键词1搜索结果</span>
          <span class="result-count" id="keyword1-count">-</span>
        </div>
        <div id="keyword1-results" class="loading">等待测试...</div>
      </div>
      <div class="result-box">
        <div class="result-header">
          <span>关键词2搜索结果</span>
          <span class="result-count" id="keyword2-count">-</span>
        </div>
        <div id="keyword2-results" class="loading">等待测试...</div>
      </div>
      <div class="result-box">
        <div class="result-header">
          <span>并集搜索结果</span>
          <span class="result-count" id="union-count">-</span>
        </div>
        <div id="union-results" class="loading">等待测试...</div>
      </div>
    </div>

    <div id="comparison" class="comparison" style="display: none;">
      <h3>搜索结果分析</h3>
      <div id="analysis-content"></div>
    </div>
  </div>

  <script>
    // 更新状态显示
    function updateStatus(message, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }

    // 显示关键词标签
    function displayKeywords(keywords) {
      const container = document.getElementById('keywords-display');
      container.innerHTML = keywords.map(kw => 
        `<span class="keyword-tag">${kw}</span>`
      ).join('');
    }

    // 高亮关键词
    function highlightKeywords(text, keywords) {
      let highlightedText = text;
      keywords.forEach((keyword, index) => {
        if (keyword) {
          const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const className = index === 0 ? 'highlight' : 'highlight-alt';
          highlightedText = highlightedText.replace(
            new RegExp(`(${escapedKeyword})`, 'gi'),
            `<span class="${className}">$1</span>`
          );
        }
      });
      return highlightedText;
    }

    // 检查题目匹配了哪些关键词
    function getMatchedKeywords(question, keywords) {
      const text = question.question_text.toLowerCase();
      return keywords.filter(kw => text.includes(kw.toLowerCase()));
    }

    // 渲染题目列表
    function renderQuestions(questions, keywords, containerId, countId) {
      const container = document.getElementById(containerId);
      const countEl = document.getElementById(countId);
      
      if (!questions || questions.length === 0) {
        container.innerHTML = '<div class="loading">没有找到题目</div>';
        countEl.textContent = '0道题';
        return;
      }

      countEl.textContent = `${questions.length}道题`;

      // 限制显示数量
      const displayQuestions = questions.slice(0, 20);
      
      container.innerHTML = displayQuestions.map((q, index) => {
        const matchedKeywords = getMatchedKeywords(q, keywords);
        let matchClass = '';
        let matchIndicator = '';
        
        if (matchedKeywords.length === keywords.length) {
          matchClass = 'match-all';
          matchIndicator = '<span class="match-indicator match-all" title="匹配所有关键词"></span>';
        } else if (matchedKeywords.length > 1) {
          matchClass = 'match-multi';
          matchIndicator = '<span class="match-indicator match-multi" title="匹配多个关键词"></span>';
        } else {
          matchClass = 'match-single';
          matchIndicator = '<span class="match-indicator match-single" title="匹配单个关键词"></span>';
        }
        
        return `
          <div class="question-item ${matchClass}">
            <div class="question-header">
              <span>#${index + 1} - ID: ${q.id}${matchIndicator}</span>
              <span>${q.year || ''} ${q.subject || ''}</span>
            </div>
            <div class="question-text">
              ${highlightKeywords(q.question_text.substring(0, 100) + '...', keywords)}
            </div>
          </div>
        `;
      }).join('');
      
      if (questions.length > 20) {
        container.innerHTML += `<div class="loading">...还有 ${questions.length - 20} 道题目</div>`;
      }
    }

    // 搜索单个关键词
    async function searchSingleKeyword(keyword, subject) {
      try {
        const params = new URLSearchParams({
          subject: subject !== 'all' ? subject : '',
          search: keyword,
          page: '1',
          limit: '100'
        });
        
        const response = await fetch(`/api/exams/questions?${params}`);
        const data = await response.json();
        
        if (data.success) {
          return data.data.questions;
        } else {
          throw new Error(data.message || '搜索失败');
        }
      } catch (error) {
        console.error(`搜索关键词 "${keyword}" 失败:`, error);
        return [];
      }
    }

    // 模拟AI跳转的并集搜索
    async function searchUnion(keywords, subject) {
      try {
        updateStatus(`正在执行多关键词并集搜索...`, 'info');
        
        // 构建URL参数，模拟从AI聊天跳转
        const jumpUrl = `/question-bank?subject=${subject}&keywords=${keywords.join(',')}&source=ai-chat`;
        console.log('模拟跳转URL:', jumpUrl);
        
        // 直接调用API进行多关键词搜索
        const allQuestions = new Map();
        
        // 并行搜索所有关键词
        const searchPromises = keywords.map(keyword => searchSingleKeyword(keyword, subject));
        const searchResults = await Promise.all(searchPromises);
        
        // 合并结果
        searchResults.forEach((questions, index) => {
          questions.forEach(q => {
            if (!allQuestions.has(q.id)) {
              allQuestions.set(q.id, {
                ...q,
                matched_keywords: [keywords[index]]
              });
            } else {
              const existing = allQuestions.get(q.id);
              if (!existing.matched_keywords.includes(keywords[index])) {
                existing.matched_keywords.push(keywords[index]);
              }
            }
          });
        });
        
        // 转换为数组并按匹配数量排序
        const mergedQuestions = Array.from(allQuestions.values())
          .sort((a, b) => {
            const scoreA = a.matched_keywords.length;
            const scoreB = b.matched_keywords.length;
            if (scoreB !== scoreA) return scoreB - scoreA;
            return a.id - b.id;
          });
        
        return mergedQuestions;
      } catch (error) {
        console.error('并集搜索错误:', error);
        updateStatus('并集搜索失败: ' + error.message, 'error');
        return [];
      }
    }

    // 分析搜索结果
    function analyzeResults(keyword1Results, keyword2Results, unionResults, keywords) {
      const analysisEl = document.getElementById('analysis-content');
      
      const k1Ids = new Set(keyword1Results.map(q => q.id));
      const k2Ids = new Set(keyword2Results.map(q => q.id));
      const unionIds = new Set(unionResults.map(q => q.id));
      
      // 计算交集和差集
      const intersection = [...k1Ids].filter(id => k2Ids.has(id));
      const onlyInK1 = [...k1Ids].filter(id => !k2Ids.has(id));
      const onlyInK2 = [...k2Ids].filter(id => !k1Ids.has(id));
      
      // 验证并集是否正确
      const expectedUnionSize = k1Ids.size + k2Ids.size - intersection.length;
      const isUnionCorrect = unionIds.size === expectedUnionSize;
      
      let html = `
        <div>
          <p><strong>关键词1 "${keywords[0]}":</strong> ${k1Ids.size} 道题</p>
          <p><strong>关键词2 "${keywords[1]}":</strong> ${k2Ids.size} 道题</p>
          <p><strong>交集（同时包含两个关键词）:</strong> ${intersection.length} 道题</p>
          <p><strong>并集（包含任一关键词）:</strong> ${unionIds.size} 道题</p>
        </div>
        
        <div style="margin-top: 15px;">
          <p><strong>并集验证:</strong></p>
          <p>预期并集大小: ${k1Ids.size} + ${k2Ids.size} - ${intersection.length} = ${expectedUnionSize}</p>
          <p>实际并集大小: ${unionIds.size}</p>
          <p>结果: ${isUnionCorrect ? 
            '<span style="color: green;">✅ 并集计算正确</span>' : 
            '<span style="color: red;">❌ 并集计算有误</span>'}</p>
        </div>
      `;
      
      if (!isUnionCorrect) {
        // 找出差异
        const missingInUnion = [...k1Ids, ...k2Ids].filter(id => !unionIds.has(id));
        const extraInUnion = [...unionIds].filter(id => !k1Ids.has(id) && !k2Ids.has(id));
        
        if (missingInUnion.length > 0) {
          html += `<p style="color: red;">缺失的题目ID: ${missingInUnion.join(', ')}</p>`;
        }
        if (extraInUnion.length > 0) {
          html += `<p style="color: red;">多余的题目ID: ${extraInUnion.join(', ')}</p>`;
        }
      }
      
      // 显示排序情况
      const multiMatchCount = unionResults.filter(q => 
        q.matched_keywords && q.matched_keywords.length > 1
      ).length;
      
      html += `
        <div style="margin-top: 15px;">
          <p><strong>排序验证:</strong></p>
          <p>匹配多个关键词的题目: ${multiMatchCount} 道</p>
          <p>这些题目应该排在前面</p>
        </div>
      `;
      
      analysisEl.innerHTML = html;
      document.getElementById('comparison').style.display = 'block';
    }

    // 运行测试
    async function runTest() {
      const subject = document.getElementById('subject').value;
      const keywordsInput = document.getElementById('keywords').value.trim();
      
      if (!keywordsInput) {
        updateStatus('请输入关键词', 'error');
        return;
      }
      
      // 解析关键词
      const keywords = keywordsInput.split(',').map(k => k.trim()).filter(k => k);
      
      if (keywords.length < 2) {
        updateStatus('请输入至少两个关键词，用逗号分隔', 'error');
        return;
      }
      
      displayKeywords(keywords);
      
      // 清空之前的结果
      ['keyword1-results', 'keyword2-results', 'union-results'].forEach(id => {
        document.getElementById(id).innerHTML = '<div class="loading">搜索中...</div>';
      });
      document.getElementById('comparison').style.display = 'none';
      
      updateStatus(`正在搜索 ${keywords.join('、')} 相关题目...`, 'info');
      
      // 并行执行三种搜索
      const [keyword1Results, keyword2Results, unionResults] = await Promise.all([
        searchSingleKeyword(keywords[0], subject),
        searchSingleKeyword(keywords[1], subject),
        searchUnion(keywords.slice(0, 2), subject) // 只使用前两个关键词进行测试
      ]);
      
      // 渲染结果
      renderQuestions(keyword1Results, [keywords[0]], 'keyword1-results', 'keyword1-count');
      renderQuestions(keyword2Results, [keywords[1]], 'keyword2-results', 'keyword2-count');
      renderQuestions(unionResults, keywords.slice(0, 2), 'union-results', 'union-count');
      
      // 分析结果
      analyzeResults(keyword1Results, keyword2Results, unionResults, keywords);
      
      updateStatus('测试完成', 'success');
    }
  </script>
</body>
</html>