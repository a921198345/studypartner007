# AI问答功能设计

## 功能描述

AI问答功能是"学习搭子"平台的核心功能之一，基于DeepSeek API实现智能问答服务，为用户提供法考相关问题的专业解答。系统将根据最新法考知识库（2025年版）为用户提供精准、专业的回答，支持图文混合提问，并能与知识导图智能联动，提供全方位的法考学习支持。

## 功能实现流程

### 1. 后台知识库构建流程

1. **资料收集与整理**：
   - 管理员收集最新法考教材、大纲、法规、案例等资料
   - 对收集的资料进行整理、分类，按学科板块组织

2. **资料上传与存储**：
   - 管理员通过后台管理界面上传PDF等格式的法考资料
   - 系统将上传的资料存储到服务器，并在数据库中记录文件路径、类型等信息

3. **知识库向量化处理**：
   - 系统使用文本提取技术从PDF等文档中提取纯文本内容
   - 将提取的文本内容分段、分块处理
   - 通过DeepSeek API将文本块转换为向量嵌入
   - 将向量化后的内容存储到向量数据库中，便于后续快速检索

### 2. 用户问答流程

1. **用户提问**：
   - 用户在问答界面的输入框中输入问题，或上传相关图片（如题目截图、法条截图等）
   - 系统接收用户的文本问题和/或图片

2. **问题处理**：
   - 对于纯文本问题，直接进入下一步处理
   - 对于包含图片的问题，使用OCR技术提取图片中的文字信息，与用户输入的文本合并处理

3. **相关知识检索**：
   - 系统将用户问题向量化
   - 在向量数据库中检索与问题最相关的知识片段
   - 根据相关性得分，选择最相关的多个知识片段

4. **AI回答生成**：
   - 将用户问题和检索到的相关知识片段一起传给DeepSeek API
   - DeepSeek API基于这些信息生成专业、准确的回答
   - 系统接收API返回的回答内容，以流式方式呈现给用户

5. **回答后处理**：
   - 系统分析AI生成的回答，提取其中涉及的关键知识点
   - 将提取的知识点与知识导图中的节点进行匹配
   - 生成"查看相关知识导图"功能所需的关联数据

### 3. 知识导图联动流程

1. **用户触发联动**：
   - AI回答结束后，系统展示"查看相关知识导图"按钮
   - 用户点击按钮，触发联动功能

2. **知识点定位**：
   - 系统根据之前提取的关键知识点信息，在知识导图中定位相关节点
   - 计算需要展开和高亮显示的导图范围

3. **导图展示**：
   - 跳转至知识导图页面
   - 自动展开包含相关知识点的分支
   - 高亮显示相关知识点
   - 其他无关分支保持折叠状态

## 业务规则

### 1. 免费用户权限控制

- 每个免费用户每日限制使用AI问答功能2次
- 系统记录用户每日已使用的问答次数及最后一次问答日期
- 每日零点自动重置使用次数
- 超出免费额度后，提示用户升级为会员
- 免费用户每日可使用2次AI问答智能联动功能
- 免费用户仅能使用民法学科真题的智能联动功能
- 免费用户仅保留最近7天的问答记录

### 2. 内容审核规则

- 用户提问前进行基础内容审核，过滤不良信息
- AI回答生成后，进行内容安全检查，避免有害或误导性内容
- 仅回答与法考学习相关的问题，对于明显偏离主题的问题，给予友好提示

### 3. 数据存储规则

- 用户问答记录存储在数据库中，包括用户ID、问题文本、图片URL、AI回答等信息
- 问答记录关联用户账户，用户可在历史记录中查看
- 定期对问答记录进行分析，优化知识库和AI模型

## 使用角色

### 1. 普通用户

- **免费用户**：
  - 每日可使用2次AI问答功能
  - 每日可使用2次AI问答智能联动功能
  - 仅能使用民法学科真题的智能联动功能
  - 仅保留最近7天的问答记录
  - 收藏的问答即使超过7天也不会被删除

- **会员用户**：
  - 无限制使用AI问答功能
  - 无限制使用智能联动功能
  - 永久保存所有问答记录
  - 优先响应问题

### 2. 管理员

- 负责上传、更新和管理知识库资料
- 监控系统问答质量，优化知识库内容
- 查看用户问答统计数据，分析常见问题

## 界面设计要求

### 1. AI问答主界面

- **布局**：
  - 页面整体采用左右结构
  - 左侧为主要对话区域
  - 右侧为侧边栏，可切换显示"学习计划"或"学习笔记"

- **对话区域设计**：
  - 对话气泡式布局，用户问题右侧显示，AI回答左侧显示
  - 用户问题气泡使用主色调，AI回答气泡使用白色背景+浅灰色边框
  - 支持Markdown格式显示，便于结构化呈现复杂内容
  - AI回答采用打字机效果流式展示，增强交互感
  - 对话区顶部显示会话标题，可编辑
  - 对话区底部为输入框区域

- **输入框设计**：
  - 固定在页面底部的输入框，高度可随输入内容自动调整
  - 输入框左侧提供图片上传按钮
  - 输入框右侧为发送按钮
  - 支持快捷键：Shift+Enter换行，Enter发送

- **侧边栏设计**：
  - 顶部提供"学习计划"和"学习笔记"两个选项卡
  - 内容区根据选择的选项卡显示相应内容
  - 提供收起/展开按钮，允许用户最大化对话区域

### 2. 提问相关交互

- **输入状态提示**：
  - 输入框占位符文本："输入您的法考问题，或上传题目截图..."
  - 免费用户显示剩余提问次数："今日剩余：X次"

- **图片上传交互**：
  - 点击上传按钮，弹出文件选择对话框
  - 支持拖拽上传
  - 上传前进行简单的格式和大小校验
  - 上传成功后在输入框中显示缩略图

- **提问过程反馈**：
  - 发送问题后，显示加载动画
  - 若包含图片，显示"正在分析图片..."
  - 问题处理完成后，立即开始流式展示回答

### 3. AI回答相关交互

- **回答呈现方式**：
  - 采用流式响应，实时展示AI思考和回答过程
  - 支持代码块、表格等复杂格式
  - 关键法条或重要内容使用醒目样式突出显示

- **操作按钮**：
  - 每个AI回答下方提供"复制回答"按钮
  - 回答结束后显示"查看相关知识导图"按钮(会员功能)
  - 提供评价按钮（👍/👎），收集用户反馈

- **免费用户提示**：
  - 免费用户用完额度后，显示友好的提示卡片
  - 提示卡片包含升级会员的按钮和会员权益简介

### 4. 响应式设计

- **桌面端**：
  - 左右布局，对话区域和侧边栏并排显示
  - 侧边栏宽度固定，对话区域自适应

- **平板端**：
  - 侧边栏可通过按钮切换显示/隐藏
  - 对话区域在侧边栏隐藏时占满宽度

- **移动端**：
  - 采用上下布局，对话区域位于上方，输入区域固定在下方
  - 侧边栏通过抽屉式菜单展示，默认隐藏
  - 简化部分交互，确保基本功能可用

## 技术实现要点

### 1. 前端技术

- **框架**：React.js
- **UI组件**：Ant Design
- **状态管理**：Redux存储对话历史和用户状态
- **API通信**：Axios处理HTTP请求
- **Markdown渲染**：使用react-markdown处理格式化文本
- **代码高亮**：使用prism.js或highlight.js
- **流式响应**：使用EventSource或WebSocket实现打字机效果
- **图片上传**：使用antd上传组件，支持预览和进度条

### 2. 后端技术

- **框架**：Node.js + Express.js
- **API设计**：RESTful风格API
- **AI集成**：DeepSeek API接入
- **向量数据库**：使用Pinecone或Milvus存储向量化知识库
- **图片处理**：使用tesseract.js进行OCR识别
- **流式响应**：使用Server-Sent Events技术实现

### 3. 安全性考虑

- **输入验证**：前后端双重验证用户输入，防止XSS攻击
- **频率限制**：设置API调用频率限制，防止滥用
- **数据加密**：敏感数据传输加密
- **访问控制**：基于JWT的认证和授权机制

## 性能优化策略

1. **知识库索引优化**：
   - 对知识库内容进行合理分块，提高检索精准度
   - 使用高效的向量检索算法，减少响应时间

2. **缓存机制**：
   - 常见问题答案缓存
   - 用户会话状态缓存
   - 知识点关联缓存

3. **延迟加载**：
   - 历史对话记录分页加载
   - 图片懒加载
   - 非关键JS资源异步加载

4. **流量控制**：
   - API调用限流
   - 大文件上传限制
   - 结果分块传输

## 测试计划

1. **功能测试**：
   - 验证问答基本功能
   - 图片上传和OCR识别测试
   - 知识导图联动功能测试
   - 会员权限控制测试

2. **性能测试**：
   - 响应时间测试
   - 并发用户测试
   - 大量数据下的系统表现

3. **用户体验测试**：
   - 邀请法考学生进行实际使用测试
   - 收集用户反馈，优化交互设计

## 上线与运维计划

1. **分阶段上线**：
   - 内部测试阶段：开发人员和测试人员使用
   - 小范围公测：邀请部分用户试用
   - 正式上线：全面开放

2. **监控与告警**：
   - 设置系统性能监控
   - 异常情况自动告警
   - 用户行为数据分析

3. **定期优化**：
   - 基于用户反馈持续改进
   - 定期更新知识库内容
   - 根据性能数据优化系统架构 