<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>答题历史迁移测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .data-display {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>答题历史迁移测试</h1>
        
        <div class="test-section">
            <h2>1. 检查本地数据</h2>
            <button onclick="checkLocalData()">检查本地存储</button>
            <div id="localDataStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>2. 创建测试数据</h2>
            <button onclick="createTestData()">创建测试答题会话</button>
            <button onclick="clearLocalData()">清除本地数据</button>
            <div id="testDataStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>3. 测试数据迁移</h2>
            <button onclick="testMigration()">执行数据迁移</button>
            <div id="migrationStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>4. 验证数据库数据</h2>
            <button onclick="fetchDatabaseSessions()">获取数据库会话</button>
            <div id="databaseStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>5. 测试答题流程</h2>
            <button onclick="testAnswerSubmission()">测试提交答案</button>
            <div id="answerStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>日志输出</h2>
            <div id="logOutput" class="log"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="status ${type}">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}]`, message);
        }

        function displayData(elementId, data, title) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <h3>${title}</h3>
                <div class="data-display">
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }

        async function checkLocalData() {
            log('开始检查本地存储数据...', 'info');
            
            const localData = {
                answerHistory: localStorage.getItem('answerHistory'),
                answerSessions: localStorage.getItem('answerSessions'),
                currentAnswerSession: localStorage.getItem('currentAnswerSession'),
                answerHistoryMigrated: localStorage.getItem('answerHistoryMigrated')
            };
            
            const summary = {
                hasAnswerHistory: !!localData.answerHistory,
                hasAnswerSessions: !!localData.answerSessions,
                hasCurrentSession: !!localData.currentAnswerSession,
                isMigrated: localData.answerHistoryMigrated === 'true',
                sessionCount: 0,
                answeredCount: 0
            };
            
            try {
                if (localData.answerSessions) {
                    const sessions = JSON.parse(localData.answerSessions);
                    summary.sessionCount = sessions.length;
                }
                
                if (localData.answerHistory) {
                    const history = JSON.parse(localData.answerHistory);
                    summary.answeredCount = Object.keys(history.answered || {}).length;
                }
            } catch (e) {
                log('解析本地数据失败: ' + e.message, 'error');
            }
            
            displayData('localDataStatus', summary, '本地数据摘要');
            log('本地数据检查完成', 'success');
        }

        async function createTestData() {
            log('创建测试数据...', 'info');
            
            // 创建测试会话
            const testSessions = [
                {
                    sessionId: 'test_' + Date.now(),
                    startTime: new Date(Date.now() - 3600000).toISOString(), // 1小时前
                    endTime: new Date().toISOString(),
                    questionsAnswered: 10,
                    correctCount: 7,
                    totalQuestions: 20,
                    source: 'all',
                    filters: {
                        subject: '民法',
                        years: ['2023'],
                        types: ['单选题']
                    },
                    lastQuestionId: 10
                }
            ];
            
            // 创建测试答题历史
            const testHistory = {
                answered: {
                    '1': true,
                    '2': true,
                    '3': true,
                    '4': true,
                    '5': true
                },
                correct: {
                    '1': true,
                    '2': false,
                    '3': true,
                    '4': true,
                    '5': false
                },
                timestamp: Date.now()
            };
            
            localStorage.setItem('answerSessions', JSON.stringify(testSessions));
            localStorage.setItem('answerHistory', JSON.stringify(testHistory));
            localStorage.removeItem('answerHistoryMigrated'); // 重置迁移标记
            
            log('测试数据创建成功', 'success');
            displayData('testDataStatus', {
                sessions: testSessions,
                history: testHistory
            }, '创建的测试数据');
        }

        async function clearLocalData() {
            log('清除本地数据...', 'info');
            localStorage.removeItem('answerHistory');
            localStorage.removeItem('answerSessions');
            localStorage.removeItem('currentAnswerSession');
            localStorage.removeItem('answerHistoryMigrated');
            log('本地数据已清除', 'success');
        }

        async function testMigration() {
            log('开始执行数据迁移...', 'info');
            
            try {
                const sessionsStr = localStorage.getItem('answerSessions');
                const currentSessionStr = localStorage.getItem('currentAnswerSession');
                const historyStr = localStorage.getItem('answerHistory');
                
                const sessions = sessionsStr ? JSON.parse(sessionsStr) : [];
                const currentSession = currentSessionStr ? JSON.parse(currentSessionStr) : null;
                const answerHistory = historyStr ? JSON.parse(historyStr) : null;
                
                const response = await fetch('/api/exams/sessions/migrate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessions,
                        currentSession,
                        answerHistory
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`迁移成功！迁移了 ${result.data.migratedCount} 个会话`, 'success');
                    localStorage.setItem('answerHistoryMigrated', 'true');
                } else {
                    log('迁移失败: ' + result.message, 'error');
                }
                
                displayData('migrationStatus', result, '迁移结果');
            } catch (error) {
                log('迁移过程出错: ' + error.message, 'error');
            }
        }

        async function fetchDatabaseSessions() {
            log('获取数据库中的会话...', 'info');
            
            try {
                const response = await fetch('/api/exams/sessions');
                const result = await response.json();
                
                if (result.success) {
                    log(`获取到 ${result.data.sessions.length} 个会话`, 'success');
                    displayData('databaseStatus', result.data, '数据库会话数据');
                } else {
                    log('获取失败: ' + result.message, 'error');
                }
            } catch (error) {
                log('获取数据库会话失败: ' + error.message, 'error');
            }
        }

        async function testAnswerSubmission() {
            log('测试答题提交流程...', 'info');
            
            try {
                // 先创建一个新会话
                const createResponse = await fetch('/api/exams/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filters: { subject: '测试科目' },
                        totalQuestions: 10,
                        source: 'test'
                    })
                });
                
                const createResult = await createResponse.json();
                
                if (!createResult.success) {
                    log('创建会话失败: ' + createResult.message, 'error');
                    return;
                }
                
                const sessionId = createResult.data.sessionId;
                log('创建会话成功，ID: ' + sessionId, 'success');
                
                // 保存到localStorage模拟实际场景
                localStorage.setItem('currentAnswerSession', JSON.stringify({
                    sessionId: sessionId,
                    startTime: new Date().toISOString(),
                    questionsAnswered: 0,
                    correctCount: 0
                }));
                
                // 测试提交答案
                const submitResponse = await fetch('/api/exams/questions/1/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        submitted_answer: 'A',
                        session_id: sessionId
                    })
                });
                
                const submitResult = await submitResponse.json();
                
                if (submitResult.success) {
                    log('答案提交成功', 'success');
                    displayData('answerStatus', submitResult, '答题结果');
                    
                    // 验证会话是否更新
                    const sessionResponse = await fetch(`/api/exams/sessions/${sessionId}`);
                    const sessionData = await sessionResponse.json();
                    
                    if (sessionData.success) {
                        log('会话统计已更新', 'success');
                        displayData('answerStatus', sessionData.data, '更新后的会话信息');
                    }
                } else {
                    log('答案提交失败: ' + submitResult.message, 'error');
                }
            } catch (error) {
                log('测试答题流程失败: ' + error.message, 'error');
            }
        }
        
        // 页面加载时自动检查本地数据
        window.onload = () => {
            checkLocalData();
        };
    </script>
</body>
</html>