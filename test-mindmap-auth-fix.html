<!DOCTYPE html>
<html>
<head>
    <title>测试知识导图认证修复</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>知识导图认证问题修复测试</h1>
    
    <h2>问题分析：</h2>
    <ul>
        <li>❌ API 要求强制认证，但前端没有发送认证 header</li>
        <li>❌ 导致 401 Unauthorized 错误</li>
        <li>❌ runtime.lastError 是浏览器扩展问题，可忽略</li>
    </ul>
    
    <h2>修复方案：</h2>
    <ul>
        <li>✅ 将 API 认证改为可选（未登录用户可访问民法）</li>
        <li>✅ 保持会员权限限制（非会员只能看民法）</li>
        <li>✅ 优雅处理认证失败情况</li>
    </ul>
    
    <h2>测试方法：</h2>
    <ol>
        <li>在未登录状态下访问 <a href="http://localhost:3000/knowledge-map?subject=民法" target="_blank">民法知识导图</a></li>
        <li>检查是否还有 401 错误</li>
        <li>检查民法知识导图是否正常显示</li>
        <li>尝试访问其他学科（应该显示会员提示）</li>
    </ol>
    
    <div id="test-result" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        <p>测试结果将显示在这里...</p>
    </div>
    
    <script>
        // 测试API调用
        async function testMindMapAPI() {
            const resultDiv = document.getElementById('test-result');
            resultDiv.innerHTML = '<p>🔄 正在测试API调用...</p>';
            
            try {
                const response = await fetch('/api/mindmaps/民法');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.innerHTML = `
                        <h3 style="color: green;">✅ API 调用成功！</h3>
                        <p>状态码: ${response.status}</p>
                        <p>数据结构: ${data.mindmap ? '正确' : '错误'}</p>
                        <p>认证问题已修复 ✅</p>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <h3 style="color: red;">❌ API 调用失败</h3>
                        <p>状态码: ${response.status}</p>
                        <p>错误信息: ${data.message || '未知错误'}</p>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <h3 style="color: red;">❌ 请求失败</h3>
                    <p>错误: ${error.message}</p>
                `;
            }
        }
        
        // 页面加载完成后自动测试
        window.addEventListener('load', () => {
            setTimeout(testMindMapAPI, 1000);
        });
    </script>
    
    <button onclick="testMindMapAPI()" style="margin-top: 10px; padding: 8px 16px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer;">
        手动测试 API
    </button>
</body>
</html>