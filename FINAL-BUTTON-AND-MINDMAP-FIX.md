# 按钮显示延迟和导图搜索优化 - 最终修复方案

## 问题总结

1. **按钮显示延迟**：第一次对话结束后按钮不显示，需要开始第二次对话才显示
2. **导图搜索不智能**：直接使用用户输入的原始文本搜索，没有提取关键概念

## 修复方案

### 1. 按钮显示延迟修复

**根本原因**：流式传输完成后，组件没有正确触发重新渲染

**解决方案**：
```typescript
// 在 page.tsx 中添加双重状态更新确保重新渲染
setTimeout(() => {
  const storeState = useChatStore.getState();
  const currentConv = storeState.conversations.find(c => c.id === storeState.currentConversationId);
  if (currentConv) {
    console.log('手动刷新消息列表，当前消息数:', currentConv.messages.length);
    // 强制触发组件更新
    setAutoScroll(prev => !prev);
    setTimeout(() => setAutoScroll(prev => !prev), 50);
  }
}, 100);
```

### 2. 导图搜索智能化

**改进内容**：

1. **AI 智能提取关键词**
   - 创建了 `/api/ai/extract-keywords` 接口
   - 使用 AI 分析问题和答案，提取核心法律概念
   - 有降级方案：如果 AI 不可用，使用规则提取

2. **优化关键词提取逻辑**
   ```javascript
   // 示例映射
   "离婚考点" → "离婚 财产分割 子女抚养"
   "合同违约责任" → "合同 违约 损害赔偿"
   ```

3. **增强科目识别**
   - 添加了更多关键词
   - 使用权重计算提高准确性
   - 长关键词权重更高

## 使用说明

### 调试面板
页面右下角的调试面板会显示：
- 组件消息数
- 对话消息数
- 流式状态
- 最后两条消息

### 导图搜索体验
1. 点击"查看导图"按钮
2. 系统会智能分析对话内容
3. 提取最相关的法律概念
4. 跳转到对应科目的知识导图
5. 自动定位到相关内容

## 测试建议

1. **测试按钮显示**
   ```
   - 发送问题："什么是离婚？"
   - 等待 AI 回答完成
   - 检查按钮是否立即显示
   ```

2. **测试导图搜索**
   ```
   - 问题："离婚考点"
   - 期望搜索："离婚 财产分割 子女抚养"
   - 而不是："离婚考点"
   ```

## 技术细节

### 组件更新机制
- 使用 `setTimeout` 确保状态更新后再触发渲染
- 通过切换无关状态强制 React 重新渲染
- 添加调试日志追踪渲染过程

### AI 关键词提取
- 温度设置为 0.3 保证稳定输出
- 限制 50 个 token 确保快速响应
- 有完整的错误处理和降级方案

## 后续优化建议

1. **缓存优化**：缓存关键词提取结果，避免重复调用 AI
2. **预加载**：在 AI 回答时就开始提取关键词
3. **用户反馈**：允许用户修改搜索关键词
4. **历史记录**：记录用户的导图搜索历史