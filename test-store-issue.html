<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试消息存储问题</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .message {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .user-message {
            background: #e3f2fd;
            text-align: right;
        }
        .assistant-message {
            background: #f5f5f5;
        }
        .log {
            background: #f0f8ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .store-info {
            background: #fffbf0;
            border: 1px solid #ffa500;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>测试消息存储问题</h1>
    
    <div class="container">
        <div class="panel">
            <h2>LocalStorage 检查</h2>
            <button onclick="checkLocalStorage()">检查 LocalStorage</button>
            <button onclick="clearLocalStorage()">清空 LocalStorage</button>
            <button onclick="fixLocalStorage()">修复 LocalStorage</button>
            
            <div id="storageInfo" class="store-info"></div>
            
            <h2>消息测试</h2>
            <button onclick="simulateChat()">模拟完整聊天流程</button>
            <button onclick="testStoreDirectly()">直接测试Store</button>
            
            <div id="messages"></div>
        </div>
        
        <div class="panel">
            <h2>调试日志</h2>
            <button onclick="clearLogs()">清空日志</button>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        // 日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<div class="log ${className}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // 检查 LocalStorage
        function checkLocalStorage() {
            log('=== 检查 LocalStorage ===');
            const key = 'law-chat-storage';
            const data = localStorage.getItem(key);
            
            if (!data) {
                log('LocalStorage 中没有找到聊天数据', 'error');
                document.getElementById('storageInfo').innerHTML = '<div class="error">没有找到存储数据</div>';
                return;
            }
            
            try {
                const parsed = JSON.parse(data);
                log('找到存储数据', 'success');
                
                const info = {
                    hasState: !!parsed.state,
                    conversationCount: parsed.state?.conversations?.length || 0,
                    currentConversationId: parsed.state?.currentConversationId || '无',
                    totalMessages: 0
                };
                
                if (parsed.state?.conversations) {
                    parsed.state.conversations.forEach((conv, i) => {
                        info.totalMessages += conv.messages?.length || 0;
                        log(`对话 ${i + 1} (${conv.id}): ${conv.messages?.length || 0} 条消息`);
                    });
                }
                
                document.getElementById('storageInfo').innerHTML = `
                    <div><strong>存储状态:</strong></div>
                    <div>- 对话数: ${info.conversationCount}</div>
                    <div>- 当前对话: ${info.currentConversationId}</div>
                    <div>- 总消息数: ${info.totalMessages}</div>
                    <div>- 数据大小: ${(JSON.stringify(parsed).length / 1024).toFixed(2)} KB</div>
                `;
                
                // 显示当前对话的消息
                if (parsed.state?.currentConversationId) {
                    const currentConv = parsed.state.conversations.find(c => c.id === parsed.state.currentConversationId);
                    if (currentConv && currentConv.messages) {
                        displayMessages(currentConv.messages);
                    }
                }
                
            } catch (e) {
                log(`解析存储数据失败: ${e.message}`, 'error');
                document.getElementById('storageInfo').innerHTML = '<div class="error">数据格式错误</div>';
            }
        }
        
        // 显示消息
        function displayMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '<h3>当前对话消息:</h3>';
            
            messages.forEach((msg, index) => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${msg.role}-message`;
                msgDiv.innerHTML = `
                    <strong>${msg.role}:</strong> ${msg.content || '(空消息)'}
                    <br><small>ID: ${msg.id}</small>
                `;
                container.appendChild(msgDiv);
            });
        }
        
        // 清空 LocalStorage
        function clearLocalStorage() {
            if (confirm('确定要清空所有聊天数据吗？')) {
                localStorage.removeItem('law-chat-storage');
                log('LocalStorage 已清空', 'success');
                document.getElementById('storageInfo').innerHTML = '<div class="success">存储已清空</div>';
                document.getElementById('messages').innerHTML = '';
            }
        }
        
        // 修复 LocalStorage
        function fixLocalStorage() {
            log('=== 尝试修复 LocalStorage ===');
            
            // 创建正确的数据结构
            const fixedData = {
                state: {
                    currentConversationId: 'conv-' + Date.now(),
                    conversations: [{
                        id: 'conv-' + Date.now(),
                        title: '修复后的对话',
                        messages: [
                            {
                                id: 'welcome-' + Date.now(),
                                role: 'assistant',
                                content: '欢迎使用法考助手AI，请输入您的法考问题。',
                                timestamp: new Date().toISOString()
                            }
                        ],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }]
                },
                version: 0
            };
            
            localStorage.setItem('law-chat-storage', JSON.stringify(fixedData));
            log('LocalStorage 已修复', 'success');
            checkLocalStorage();
        }
        
        // 模拟完整聊天流程
        async function simulateChat() {
            log('=== 模拟完整聊天流程 ===');
            
            // 1. 检查初始状态
            const initialData = localStorage.getItem('law-chat-storage');
            if (!initialData) {
                log('没有初始数据，先修复存储', 'error');
                fixLocalStorage();
            }
            
            // 2. 获取当前数据
            const data = JSON.parse(localStorage.getItem('law-chat-storage'));
            const currentConvId = data.state.currentConversationId;
            const currentConv = data.state.conversations.find(c => c.id === currentConvId);
            
            if (!currentConv) {
                log('找不到当前对话', 'error');
                return;
            }
            
            // 3. 添加用户消息
            const userMessage = {
                id: 'user-' + Date.now(),
                role: 'user',
                content: '什么是保证合同？',
                timestamp: new Date().toISOString()
            };
            currentConv.messages.push(userMessage);
            log('添加用户消息: ' + userMessage.content);
            
            // 4. 添加AI消息
            const aiMessage = {
                id: 'ai-' + Date.now(),
                role: 'assistant',
                content: '保证合同是指保证人和债权人约定，当债务人不履行债务时，保证人按照约定履行债务或者承担责任的合同。',
                timestamp: new Date().toISOString()
            };
            currentConv.messages.push(aiMessage);
            log('添加AI消息: ' + aiMessage.content.substring(0, 30) + '...');
            
            // 5. 更新时间戳
            currentConv.updatedAt = new Date().toISOString();
            
            // 6. 保存回 localStorage
            localStorage.setItem('law-chat-storage', JSON.stringify(data));
            log('数据已保存到 localStorage', 'success');
            
            // 7. 重新检查
            checkLocalStorage();
        }
        
        // 直接测试Store
        function testStoreDirectly() {
            log('=== 直接测试 Zustand Store ===');
            log('请在页面控制台运行以下代码:');
            log(`
// 获取所有Zustand stores
const stores = Array.from(document.querySelectorAll('*')).map(el => el.__reactInternalInstance || el._reactInternalFiber).filter(Boolean);
console.log('找到的React实例:', stores.length);

// 或者尝试通过window对象
if (window.__zustand_stores) {
    console.log('找到Zustand stores:', window.__zustand_stores);
} else {
    console.log('未找到Zustand stores，请在React DevTools中查看');
}
            `);
        }
        
        // 清空日志
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        // 页面加载时检查
        window.onload = function() {
            log('页面已加载');
            checkLocalStorage();
        };
    </script>
</body>
</html>