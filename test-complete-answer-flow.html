<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>答题流程完整测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
        }
        .section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .info {
            color: blue;
        }
        .warning {
            color: orange;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
        }
        button:hover {
            background: #45a049;
        }
        .log {
            background: #f4f4f4;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .data-display {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>答题流程完整测试</h1>
    
    <div class="section">
        <h2>测试控制</h2>
        <button onclick="runCompleteTest()">运行完整测试</button>
        <button onclick="clearAllData()">清除所有数据</button>
        <button onclick="testLocalStorage()">测试本地存储</button>
        <button onclick="testDatabaseStorage()">测试数据库存储</button>
        <button onclick="simulateRealFlow()">模拟真实答题流程</button>
    </div>

    <div class="section">
        <h2>本地存储数据</h2>
        <div id="local-storage-data" class="data-display">
            <pre>等待检查...</pre>
        </div>
    </div>

    <div class="section">
        <h2>数据库存储数据</h2>
        <div id="database-data" class="data-display">
            <pre>等待检查...</pre>
        </div>
    </div>

    <div class="section">
        <h2>测试日志</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        // 日志输出
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        // 清除所有数据
        async function clearAllData() {
            log('开始清除所有数据...', 'info');
            
            // 清除 localStorage
            const keysToRemove = [
                'answerHistory',
                'answerHistory_wrong',
                'answerHistory_favorites',
                'answerSessions',
                'currentAnswerSession',
                'filteredQuestionsList',
                'favoriteQuestionsList',
                'wrongQuestions',
                'favoriteQuestions'
            ];
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                log(`清除 localStorage: ${key}`, 'info');
            });
            
            // 清除 sessionStorage
            sessionStorage.clear();
            log('清除 sessionStorage', 'info');
            
            log('所有数据清除完成', 'success');
            
            // 更新显示
            await updateDataDisplay();
        }

        // 测试本地存储
        async function testLocalStorage() {
            log('=== 测试本地存储 ===', 'info');
            
            // 模拟答题历史数据
            const mockHistory = {
                answered: {
                    '1': true,
                    '2': true,
                    '3': true
                },
                correct: {
                    '1': true,
                    '2': false,
                    '3': true
                },
                results: {
                    '1': {
                        submittedAnswer: 'A',
                        isCorrect: true,
                        correctAnswer: 'A',
                        explanation: '答案A是正确的',
                        questionType: 1,
                        answeredAt: new Date().toISOString()
                    },
                    '2': {
                        submittedAnswer: 'B',
                        isCorrect: false,
                        correctAnswer: 'C',
                        explanation: '正确答案应该是C',
                        questionType: 1,
                        answeredAt: new Date().toISOString()
                    },
                    '3': {
                        submittedAnswer: 'AB',
                        isCorrect: true,
                        correctAnswer: 'AB',
                        explanation: '多选题答案正确',
                        questionType: 2,
                        answeredAt: new Date().toISOString()
                    }
                },
                timestamp: Date.now()
            };
            
            // 保存到 localStorage
            localStorage.setItem('answerHistory', JSON.stringify(mockHistory));
            log('已保存模拟答题历史到 localStorage', 'success');
            
            // 验证读取
            const savedHistory = localStorage.getItem('answerHistory');
            if (savedHistory) {
                const parsed = JSON.parse(savedHistory);
                log(`成功读取答题历史: ${Object.keys(parsed.answered).length} 道题已答`, 'success');
                log(`正确: ${Object.values(parsed.correct).filter(v => v).length} 题`, 'info');
                log(`错误: ${Object.values(parsed.correct).filter(v => !v).length} 题`, 'info');
            } else {
                log('读取答题历史失败', 'error');
            }
            
            await updateDataDisplay();
        }

        // 测试数据库存储
        async function testDatabaseStorage() {
            log('=== 测试数据库存储 ===', 'info');
            
            // 注意：这需要用户已经登录
            try {
                // 获取答题历史
                const response = await fetch('/api/exams/answers/history');
                const result = await response.json();
                
                if (result.success) {
                    log(`成功获取数据库答题历史`, 'success');
                    log(`总答题数: ${result.data.totalAnswered || 0}`, 'info');
                    log(`正确数: ${result.data.totalCorrect || 0}`, 'info');
                    
                    // 显示详细记录
                    if (result.data.records && result.data.records.length > 0) {
                        log(`最近答题记录:`, 'info');
                        result.data.records.slice(0, 5).forEach(record => {
                            log(`  题目${record.question_id}: ${record.submitted_answer} - ${record.is_correct ? '正确' : '错误'}`, 'info');
                        });
                    }
                } else {
                    log(`获取数据库历史失败: ${result.message}`, 'warning');
                    if (result.message === "未登录用户") {
                        log('提示: 数据库存储需要用户登录', 'warning');
                    }
                }
            } catch (error) {
                log(`数据库请求失败: ${error.message}`, 'error');
            }
            
            await updateDataDisplay();
        }

        // 模拟真实答题流程
        async function simulateRealFlow() {
            log('=== 模拟真实答题流程 ===', 'info');
            
            // 1. 获取一道题目
            log('步骤1: 获取题目详情', 'info');
            try {
                const questionResponse = await fetch('/api/exams/questions/1');
                const questionData = await questionResponse.json();
                
                if (questionData.success) {
                    log(`获取题目成功: ${questionData.data.question_text.substring(0, 50)}...`, 'success');
                    
                    // 2. 提交答案
                    log('步骤2: 提交答案 A', 'info');
                    const submitResponse = await fetch('/api/exams/questions/1/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            submitted_answer: 'A'
                        })
                    });
                    
                    const submitResult = await submitResponse.json();
                    
                    if (submitResult.success) {
                        log(`答案提交成功: ${submitResult.data.is_correct ? '正确' : '错误'}`, 'success');
                        log(`正确答案: ${submitResult.data.correct_answer}`, 'info');
                        
                        // 3. 模拟前端保存到 localStorage
                        log('步骤3: 保存到本地存储', 'info');
                        
                        const currentHistory = JSON.parse(localStorage.getItem('answerHistory') || '{"answered":{},"correct":{},"results":{},"timestamp":0}');
                        currentHistory.answered['1'] = true;
                        currentHistory.correct['1'] = submitResult.data.is_correct;
                        currentHistory.results['1'] = {
                            submittedAnswer: 'A',
                            isCorrect: submitResult.data.is_correct,
                            correctAnswer: submitResult.data.correct_answer,
                            explanation: submitResult.data.explanation || '暂无解析',
                            questionType: 1,
                            answeredAt: new Date().toISOString()
                        };
                        currentHistory.timestamp = Date.now();
                        
                        localStorage.setItem('answerHistory', JSON.stringify(currentHistory));
                        log('已保存到本地存储', 'success');
                    } else {
                        log(`提交答案失败: ${submitResult.message}`, 'error');
                    }
                } else {
                    log(`获取题目失败: ${questionData.message}`, 'error');
                }
            } catch (error) {
                log(`模拟流程出错: ${error.message}`, 'error');
            }
            
            await updateDataDisplay();
        }

        // 更新数据显示
        async function updateDataDisplay() {
            // 显示本地存储数据
            const localData = {};
            ['answerHistory', 'answerSessions', 'currentAnswerSession'].forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        localData[key] = JSON.parse(value);
                    } catch (e) {
                        localData[key] = value;
                    }
                }
            });
            
            document.getElementById('local-storage-data').innerHTML = 
                `<pre>${JSON.stringify(localData, null, 2)}</pre>`;
            
            // 显示数据库数据
            try {
                const response = await fetch('/api/exams/answers/history');
                const result = await response.json();
                
                document.getElementById('database-data').innerHTML = 
                    `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('database-data').innerHTML = 
                    `<pre>无法获取数据库数据: ${error.message}</pre>`;
            }
        }

        // 运行完整测试
        async function runCompleteTest() {
            log('===== 开始完整测试 =====', 'info');
            
            await clearAllData();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testLocalStorage();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testDatabaseStorage();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await simulateRealFlow();
            
            log('===== 测试完成 =====', 'success');
            log('总结: 系统使用 localStorage 存储答题历史，数据库存储仅在用户登录时可用', 'info');
        }

        // 页面加载时更新显示
        window.onload = function() {
            updateDataDisplay();
        };
    </script>
</body>
</html>