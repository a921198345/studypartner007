<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>暂停功能测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .test-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-item {
      margin: 15px 0;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    .success { background-color: #e8f5e9; border-color: #4caf50; }
    .error { background-color: #ffebee; border-color: #f44336; }
    .warning { background-color: #fff3e0; border-color: #ff9800; }
    .info { background-color: #e3f2fd; border-color: #2196f3; }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .primary { background-color: #2196f3; color: white; }
    .danger { background-color: #f44336; color: white; }
    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    #log {
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>暂停功能测试工具</h1>
    
    <div class="test-item info">
      <h3>测试说明</h3>
      <p>这个工具将帮助您测试和调试暂停功能。请按照以下步骤操作：</p>
      <ol>
        <li>打开 AI 聊天页面 (http://localhost:3001/ai-chat)</li>
        <li>在浏览器控制台中运行下面的测试脚本</li>
        <li>发送一个会产生长回答的问题</li>
        <li>在 AI 回答时点击暂停按钮</li>
        <li>查看控制台输出</li>
      </ol>
    </div>
    
    <div class="test-item">
      <h3>测试脚本</h3>
      <button class="primary" onclick="copyTestScript()">复制测试脚本</button>
      <pre id="testScript">
// 暂停功能测试脚本
console.clear();
console.log('%c=== 暂停功能测试开始 ===', 'color: blue; font-size: 16px; font-weight: bold');

// 监控暂停按钮
const monitorPauseButton = () => {
  console.log('🔍 开始监控暂停按钮...');
  
  let buttonFound = false;
  const checkInterval = setInterval(() => {
    const buttons = document.querySelectorAll('button');
    const pauseButton = Array.from(buttons).find(btn => {
      const hasSquareIcon = btn.querySelector('svg.lucide-square');
      const isDestructive = btn.classList.contains('destructive') || 
                           btn.getAttribute('data-variant') === 'destructive' ||
                           btn.className.includes('destructive');
      return hasSquareIcon && isDestructive;
    });
    
    if (pauseButton && !buttonFound) {
      buttonFound = true;
      console.log('✅ 找到暂停按钮');
      
      // 添加视觉提示
      pauseButton.style.border = '3px solid red';
      pauseButton.style.boxShadow = '0 0 15px rgba(255,0,0,0.5)';
      
      // 监听点击事件
      pauseButton.addEventListener('click', (e) => {
        console.log('%c🛑 暂停按钮被点击！', 'color: red; font-size: 14px; font-weight: bold');
        console.log('点击事件详情:', {
          target: e.target,
          currentTarget: e.currentTarget,
          timeStamp: e.timeStamp
        });
      });
      
      console.log('按钮状态:', {
        disabled: pauseButton.disabled,
        visible: pauseButton.offsetParent !== null,
        className: pauseButton.className
      });
    }
    
    if (!pauseButton && buttonFound) {
      buttonFound = false;
      console.log('⚠️ 暂停按钮消失了');
    }
  }, 500);
  
  // 30秒后停止监控
  setTimeout(() => {
    clearInterval(checkInterval);
    console.log('🔍 停止监控暂停按钮');
  }, 30000);
};

// 监控网络请求
const monitorNetworkRequests = () => {
  console.log('🌐 开始监控网络请求...');
  
  const originalFetch = window.fetch;
  let activeStream = null;
  
  window.fetch = function(...args) {
    const url = args[0];
    
    if (url.includes('/api/ai/ask/stream')) {
      console.log('%c📡 检测到流式API请求', 'color: green; font-weight: bold');
      console.log('请求参数:', args);
      
      const promise = originalFetch.apply(this, args);
      
      promise.then(response => {
        console.log('📡 流式响应状态:', response.status);
        
        if (response.body) {
          const reader = response.body.getReader();
          activeStream = reader;
          console.log('📖 保存了 Reader 对象');
          
          // 监控 cancel 方法
          const originalCancel = reader.cancel.bind(reader);
          reader.cancel = function() {
            console.log('%c🛑 Reader.cancel() 被调用！', 'color: red; font-size: 16px; font-weight: bold');
            console.trace('调用栈:');
            return originalCancel();
          };
        }
      }).catch(err => {
        console.error('流式请求错误:', err);
      });
      
      return promise;
    }
    
    return originalFetch.apply(this, args);
  };
};

// 检查 React 组件状态
const checkReactState = () => {
  console.log('⚛️ 检查 React 状态...');
  
  // 尝试获取 React DevTools
  if (window.__REACT_DEVTOOLS_GLOBAL_HOOK__) {
    console.log('✅ React DevTools 可用');
    
    // 检查是否有 cancelStreamRef
    const checkForCancelRef = () => {
      const allElements = document.querySelectorAll('*');
      for (let el of allElements) {
        if (el._reactInternalFiber || el._reactInternalInstance) {
          console.log('找到 React 元素:', el);
        }
      }
    };
    
    setTimeout(checkForCancelRef, 2000);
  } else {
    console.log('❌ React DevTools 不可用');
  }
};

// 提供测试建议
const suggestTests = () => {
  console.log('%c📝 测试建议', 'color: purple; font-size: 14px; font-weight: bold');
  console.log(`
1. 发送这个问题来触发长回答:
   "请详细解释民法中的物权变动原则，包括公示公信原则的具体体现和例外情况"

2. 或者发送:
   "请列举并详细说明刑法中的所有犯罪构成要件，每个要件都要举例说明"

3. 在 AI 开始回答后，等待 2-3 秒再点击暂停按钮

4. 观察控制台输出，特别注意:
   - 是否有 "暂停按钮被点击" 的日志
   - 是否有 "Reader.cancel() 被调用" 的日志
   - 是否有任何错误信息
  `);
};

// 开始监控
monitorPauseButton();
monitorNetworkRequests();
checkReactState();
suggestTests();

// 提供手动测试函数
window.pauseTest = {
  findButton: () => {
    const buttons = document.querySelectorAll('button');
    return Array.from(buttons).find(btn => 
      btn.querySelector('svg.lucide-square') && 
      (btn.classList.contains('destructive') || btn.className.includes('destructive'))
    );
  },
  
  clickButton: () => {
    const btn = window.pauseTest.findButton();
    if (btn) {
      console.log('手动触发暂停按钮点击');
      btn.click();
    } else {
      console.log('未找到暂停按钮');
    }
  },
  
  checkState: () => {
    const btn = window.pauseTest.findButton();
    console.log('当前状态:', {
      buttonExists: !!btn,
      buttonDisabled: btn?.disabled,
      buttonVisible: btn?.offsetParent !== null
    });
  }
};

console.log('%c测试脚本加载完成！', 'color: green; font-size: 14px; font-weight: bold');
console.log('可以使用 window.pauseTest 对象进行手动测试');
      </pre>
    </div>
    
    <div class="test-item">
      <h3>常见问题</h3>
      <div class="warning" style="padding: 10px; margin: 10px 0;">
        <strong>问题 1:</strong> 暂停按钮点击了但没有效果
        <br><strong>原因:</strong> 取消函数可能没有正确保存或传递
        <br><strong>解决:</strong> 检查 cancelStreamRef.current 是否有值
      </div>
      
      <div class="warning" style="padding: 10px; margin: 10px 0;">
        <strong>问题 2:</strong> Reader.cancel() 没有被调用
        <br><strong>原因:</strong> 取消函数可能在错误的时机被调用
        <br><strong>解决:</strong> 确保在流式传输开始后再点击暂停
      </div>
      
      <div class="warning" style="padding: 10px; margin: 10px 0;">
        <strong>问题 3:</strong> 暂停后仍有新内容出现
        <br><strong>原因:</strong> 可能有缓存的 token 还在处理
        <br><strong>解决:</strong> 在 onToken 中检查取消状态
      </div>
    </div>
    
    <div class="test-item">
      <h3>修复验证</h3>
      <p>如果修复成功，您应该看到以下行为：</p>
      <ul>
        <li class="success" style="padding: 5px;">✅ 点击暂停按钮后，AI 立即停止生成新内容</li>
        <li class="success" style="padding: 5px;">✅ 控制台显示 "Reader.cancel() 被调用"</li>
        <li class="success" style="padding: 5px;">✅ 消息末尾添加 "[已暂停]" 标记</li>
        <li class="success" style="padding: 5px;">✅ 暂停后可以手动滚动查看内容</li>
      </ul>
    </div>
  </div>
  
  <script>
    function copyTestScript() {
      const script = document.getElementById('testScript').textContent;
      navigator.clipboard.writeText(script).then(() => {
        alert('测试脚本已复制到剪贴板！\n请在 AI 聊天页面的控制台中粘贴运行。');
      }).catch(err => {
        console.error('复制失败:', err);
        alert('复制失败，请手动选择并复制代码。');
      });
    }
  </script>
</body>
</html>