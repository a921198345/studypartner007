<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æš‚åœåŠŸèƒ½æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .test-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-item {
      margin: 15px 0;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    .success { background-color: #e8f5e9; border-color: #4caf50; }
    .error { background-color: #ffebee; border-color: #f44336; }
    .warning { background-color: #fff3e0; border-color: #ff9800; }
    .info { background-color: #e3f2fd; border-color: #2196f3; }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .primary { background-color: #2196f3; color: white; }
    .danger { background-color: #f44336; color: white; }
    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    #log {
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>æš‚åœåŠŸèƒ½æµ‹è¯•å·¥å…·</h1>
    
    <div class="test-item info">
      <h3>æµ‹è¯•è¯´æ˜</h3>
      <p>è¿™ä¸ªå·¥å…·å°†å¸®åŠ©æ‚¨æµ‹è¯•å’Œè°ƒè¯•æš‚åœåŠŸèƒ½ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>
      <ol>
        <li>æ‰“å¼€ AI èŠå¤©é¡µé¢ (http://localhost:3001/ai-chat)</li>
        <li>åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œä¸‹é¢çš„æµ‹è¯•è„šæœ¬</li>
        <li>å‘é€ä¸€ä¸ªä¼šäº§ç”Ÿé•¿å›ç­”çš„é—®é¢˜</li>
        <li>åœ¨ AI å›ç­”æ—¶ç‚¹å‡»æš‚åœæŒ‰é’®</li>
        <li>æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º</li>
      </ol>
    </div>
    
    <div class="test-item">
      <h3>æµ‹è¯•è„šæœ¬</h3>
      <button class="primary" onclick="copyTestScript()">å¤åˆ¶æµ‹è¯•è„šæœ¬</button>
      <pre id="testScript">
// æš‚åœåŠŸèƒ½æµ‹è¯•è„šæœ¬
console.clear();
console.log('%c=== æš‚åœåŠŸèƒ½æµ‹è¯•å¼€å§‹ ===', 'color: blue; font-size: 16px; font-weight: bold');

// ç›‘æ§æš‚åœæŒ‰é’®
const monitorPauseButton = () => {
  console.log('ğŸ” å¼€å§‹ç›‘æ§æš‚åœæŒ‰é’®...');
  
  let buttonFound = false;
  const checkInterval = setInterval(() => {
    const buttons = document.querySelectorAll('button');
    const pauseButton = Array.from(buttons).find(btn => {
      const hasSquareIcon = btn.querySelector('svg.lucide-square');
      const isDestructive = btn.classList.contains('destructive') || 
                           btn.getAttribute('data-variant') === 'destructive' ||
                           btn.className.includes('destructive');
      return hasSquareIcon && isDestructive;
    });
    
    if (pauseButton && !buttonFound) {
      buttonFound = true;
      console.log('âœ… æ‰¾åˆ°æš‚åœæŒ‰é’®');
      
      // æ·»åŠ è§†è§‰æç¤º
      pauseButton.style.border = '3px solid red';
      pauseButton.style.boxShadow = '0 0 15px rgba(255,0,0,0.5)';
      
      // ç›‘å¬ç‚¹å‡»äº‹ä»¶
      pauseButton.addEventListener('click', (e) => {
        console.log('%cğŸ›‘ æš‚åœæŒ‰é’®è¢«ç‚¹å‡»ï¼', 'color: red; font-size: 14px; font-weight: bold');
        console.log('ç‚¹å‡»äº‹ä»¶è¯¦æƒ…:', {
          target: e.target,
          currentTarget: e.currentTarget,
          timeStamp: e.timeStamp
        });
      });
      
      console.log('æŒ‰é’®çŠ¶æ€:', {
        disabled: pauseButton.disabled,
        visible: pauseButton.offsetParent !== null,
        className: pauseButton.className
      });
    }
    
    if (!pauseButton && buttonFound) {
      buttonFound = false;
      console.log('âš ï¸ æš‚åœæŒ‰é’®æ¶ˆå¤±äº†');
    }
  }, 500);
  
  // 30ç§’ååœæ­¢ç›‘æ§
  setTimeout(() => {
    clearInterval(checkInterval);
    console.log('ğŸ” åœæ­¢ç›‘æ§æš‚åœæŒ‰é’®');
  }, 30000);
};

// ç›‘æ§ç½‘ç»œè¯·æ±‚
const monitorNetworkRequests = () => {
  console.log('ğŸŒ å¼€å§‹ç›‘æ§ç½‘ç»œè¯·æ±‚...');
  
  const originalFetch = window.fetch;
  let activeStream = null;
  
  window.fetch = function(...args) {
    const url = args[0];
    
    if (url.includes('/api/ai/ask/stream')) {
      console.log('%cğŸ“¡ æ£€æµ‹åˆ°æµå¼APIè¯·æ±‚', 'color: green; font-weight: bold');
      console.log('è¯·æ±‚å‚æ•°:', args);
      
      const promise = originalFetch.apply(this, args);
      
      promise.then(response => {
        console.log('ğŸ“¡ æµå¼å“åº”çŠ¶æ€:', response.status);
        
        if (response.body) {
          const reader = response.body.getReader();
          activeStream = reader;
          console.log('ğŸ“– ä¿å­˜äº† Reader å¯¹è±¡');
          
          // ç›‘æ§ cancel æ–¹æ³•
          const originalCancel = reader.cancel.bind(reader);
          reader.cancel = function() {
            console.log('%cğŸ›‘ Reader.cancel() è¢«è°ƒç”¨ï¼', 'color: red; font-size: 16px; font-weight: bold');
            console.trace('è°ƒç”¨æ ˆ:');
            return originalCancel();
          };
        }
      }).catch(err => {
        console.error('æµå¼è¯·æ±‚é”™è¯¯:', err);
      });
      
      return promise;
    }
    
    return originalFetch.apply(this, args);
  };
};

// æ£€æŸ¥ React ç»„ä»¶çŠ¶æ€
const checkReactState = () => {
  console.log('âš›ï¸ æ£€æŸ¥ React çŠ¶æ€...');
  
  // å°è¯•è·å– React DevTools
  if (window.__REACT_DEVTOOLS_GLOBAL_HOOK__) {
    console.log('âœ… React DevTools å¯ç”¨');
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ cancelStreamRef
    const checkForCancelRef = () => {
      const allElements = document.querySelectorAll('*');
      for (let el of allElements) {
        if (el._reactInternalFiber || el._reactInternalInstance) {
          console.log('æ‰¾åˆ° React å…ƒç´ :', el);
        }
      }
    };
    
    setTimeout(checkForCancelRef, 2000);
  } else {
    console.log('âŒ React DevTools ä¸å¯ç”¨');
  }
};

// æä¾›æµ‹è¯•å»ºè®®
const suggestTests = () => {
  console.log('%cğŸ“ æµ‹è¯•å»ºè®®', 'color: purple; font-size: 14px; font-weight: bold');
  console.log(`
1. å‘é€è¿™ä¸ªé—®é¢˜æ¥è§¦å‘é•¿å›ç­”:
   "è¯·è¯¦ç»†è§£é‡Šæ°‘æ³•ä¸­çš„ç‰©æƒå˜åŠ¨åŸåˆ™ï¼ŒåŒ…æ‹¬å…¬ç¤ºå…¬ä¿¡åŸåˆ™çš„å…·ä½“ä½“ç°å’Œä¾‹å¤–æƒ…å†µ"

2. æˆ–è€…å‘é€:
   "è¯·åˆ—ä¸¾å¹¶è¯¦ç»†è¯´æ˜åˆ‘æ³•ä¸­çš„æ‰€æœ‰çŠ¯ç½ªæ„æˆè¦ä»¶ï¼Œæ¯ä¸ªè¦ä»¶éƒ½è¦ä¸¾ä¾‹è¯´æ˜"

3. åœ¨ AI å¼€å§‹å›ç­”åï¼Œç­‰å¾… 2-3 ç§’å†ç‚¹å‡»æš‚åœæŒ‰é’®

4. è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºï¼Œç‰¹åˆ«æ³¨æ„:
   - æ˜¯å¦æœ‰ "æš‚åœæŒ‰é’®è¢«ç‚¹å‡»" çš„æ—¥å¿—
   - æ˜¯å¦æœ‰ "Reader.cancel() è¢«è°ƒç”¨" çš„æ—¥å¿—
   - æ˜¯å¦æœ‰ä»»ä½•é”™è¯¯ä¿¡æ¯
  `);
};

// å¼€å§‹ç›‘æ§
monitorPauseButton();
monitorNetworkRequests();
checkReactState();
suggestTests();

// æä¾›æ‰‹åŠ¨æµ‹è¯•å‡½æ•°
window.pauseTest = {
  findButton: () => {
    const buttons = document.querySelectorAll('button');
    return Array.from(buttons).find(btn => 
      btn.querySelector('svg.lucide-square') && 
      (btn.classList.contains('destructive') || btn.className.includes('destructive'))
    );
  },
  
  clickButton: () => {
    const btn = window.pauseTest.findButton();
    if (btn) {
      console.log('æ‰‹åŠ¨è§¦å‘æš‚åœæŒ‰é’®ç‚¹å‡»');
      btn.click();
    } else {
      console.log('æœªæ‰¾åˆ°æš‚åœæŒ‰é’®');
    }
  },
  
  checkState: () => {
    const btn = window.pauseTest.findButton();
    console.log('å½“å‰çŠ¶æ€:', {
      buttonExists: !!btn,
      buttonDisabled: btn?.disabled,
      buttonVisible: btn?.offsetParent !== null
    });
  }
};

console.log('%cæµ‹è¯•è„šæœ¬åŠ è½½å®Œæˆï¼', 'color: green; font-size: 14px; font-weight: bold');
console.log('å¯ä»¥ä½¿ç”¨ window.pauseTest å¯¹è±¡è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•');
      </pre>
    </div>
    
    <div class="test-item">
      <h3>å¸¸è§é—®é¢˜</h3>
      <div class="warning" style="padding: 10px; margin: 10px 0;">
        <strong>é—®é¢˜ 1:</strong> æš‚åœæŒ‰é’®ç‚¹å‡»äº†ä½†æ²¡æœ‰æ•ˆæœ
        <br><strong>åŸå› :</strong> å–æ¶ˆå‡½æ•°å¯èƒ½æ²¡æœ‰æ­£ç¡®ä¿å­˜æˆ–ä¼ é€’
        <br><strong>è§£å†³:</strong> æ£€æŸ¥ cancelStreamRef.current æ˜¯å¦æœ‰å€¼
      </div>
      
      <div class="warning" style="padding: 10px; margin: 10px 0;">
        <strong>é—®é¢˜ 2:</strong> Reader.cancel() æ²¡æœ‰è¢«è°ƒç”¨
        <br><strong>åŸå› :</strong> å–æ¶ˆå‡½æ•°å¯èƒ½åœ¨é”™è¯¯çš„æ—¶æœºè¢«è°ƒç”¨
        <br><strong>è§£å†³:</strong> ç¡®ä¿åœ¨æµå¼ä¼ è¾“å¼€å§‹åå†ç‚¹å‡»æš‚åœ
      </div>
      
      <div class="warning" style="padding: 10px; margin: 10px 0;">
        <strong>é—®é¢˜ 3:</strong> æš‚åœåä»æœ‰æ–°å†…å®¹å‡ºç°
        <br><strong>åŸå› :</strong> å¯èƒ½æœ‰ç¼“å­˜çš„ token è¿˜åœ¨å¤„ç†
        <br><strong>è§£å†³:</strong> åœ¨ onToken ä¸­æ£€æŸ¥å–æ¶ˆçŠ¶æ€
      </div>
    </div>
    
    <div class="test-item">
      <h3>ä¿®å¤éªŒè¯</h3>
      <p>å¦‚æœä¿®å¤æˆåŠŸï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ä»¥ä¸‹è¡Œä¸ºï¼š</p>
      <ul>
        <li class="success" style="padding: 5px;">âœ… ç‚¹å‡»æš‚åœæŒ‰é’®åï¼ŒAI ç«‹å³åœæ­¢ç”Ÿæˆæ–°å†…å®¹</li>
        <li class="success" style="padding: 5px;">âœ… æ§åˆ¶å°æ˜¾ç¤º "Reader.cancel() è¢«è°ƒç”¨"</li>
        <li class="success" style="padding: 5px;">âœ… æ¶ˆæ¯æœ«å°¾æ·»åŠ  "[å·²æš‚åœ]" æ ‡è®°</li>
        <li class="success" style="padding: 5px;">âœ… æš‚åœåå¯ä»¥æ‰‹åŠ¨æ»šåŠ¨æŸ¥çœ‹å†…å®¹</li>
      </ul>
    </div>
  </div>
  
  <script>
    function copyTestScript() {
      const script = document.getElementById('testScript').textContent;
      navigator.clipboard.writeText(script).then(() => {
        alert('æµ‹è¯•è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\nè¯·åœ¨ AI èŠå¤©é¡µé¢çš„æ§åˆ¶å°ä¸­ç²˜è´´è¿è¡Œã€‚');
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶ä»£ç ã€‚');
      });
    }
  </script>
</body>
</html>