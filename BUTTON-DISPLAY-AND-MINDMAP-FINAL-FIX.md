# 按钮显示和导图搜索最终修复方案

## 问题汇总

1. **按钮显示延迟**：第一次对话结束后按钮不显示，需要第二次对话才出现
2. **相同问题自动跳转**：提问相同问题时会自动跳转到历史对话（用户提到但未找到相关代码）
3. **导图搜索关键词过长**：需要高度概括为单个核心词

## 已实施的修复

### 1. 按钮显示问题修复

在 `app/ai-chat/page.tsx` 中强化了组件重新渲染机制：

```typescript
// 强制刷新消息列表
const forceUpdate = () => {
  // 强制React重新渲染整个组件树
  setAutoScroll(prev => !prev);
  setTimeout(() => {
    setAutoScroll(prev => !prev);
    // 触发额外的状态更新确保渲染
    setCurrentStreamingMessageId(null);
  }, 50);
};

// 立即和延迟都执行一次，确保状态同步
forceUpdate();
setTimeout(forceUpdate, 200);
```

这个方案通过：
- 双重状态切换强制React重新渲染
- 立即执行 + 延迟执行确保状态完全同步
- 额外的状态更新作为保险措施

### 2. 导图搜索关键词优化

完全重写了 `MindMapButton.tsx` 的关键词提取逻辑：

#### 核心改进：
1. **概念映射表**：将复杂短语映射到单个核心词
   - "离婚考点" → "离婚"
   - "合同违约" → "合同"
   - "诈骗罪" → "诈骗"

2. **优先级提取**：
   - 首先检查概念映射表
   - 然后查找核心法律术语
   - 最后提取最长的有意义词汇

3. **移除了AI提取**：直接使用规则提取，更快更准确

### 3. 关于相同问题自动跳转

经过代码审查，未发现自动跳转到历史对话的逻辑。可能的原因：
- 浏览器的历史记录行为
- 或是其他组件的副作用
- 建议继续观察此问题

## 测试建议

### 测试按钮显示
1. 清空所有对话历史
2. 发送问题："离婚考点"
3. 等待AI回答完成
4. **预期结果**：按钮应立即显示

### 测试导图搜索
1. 点击"查看导图"按钮
2. **预期结果**：
   - "离婚考点" → 搜索关键词："离婚"
   - "诈骗罪" → 搜索关键词："诈骗"
   - "合同违约责任" → 搜索关键词："合同"

## 技术要点

### 状态管理
- 使用 Zustand 的 `getState()` 获取最新状态
- 通过无关状态切换强制重新渲染
- 多重保险机制确保渲染触发

### 关键词提取
- 基于规则的映射表
- 单词优先级排序
- 返回单个最核心的概念词

## 后续优化建议

1. **性能优化**：考虑使用 React 18 的 `useSyncExternalStore` 优化状态同步
2. **用户体验**：添加关键词预览，让用户知道将要搜索什么
3. **扩展映射表**：根据用户使用情况不断完善概念映射表