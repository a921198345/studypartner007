<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试会话修复</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .test-section h2 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        button {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #1565c0;
        }
        .log-container {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            background-color: white;
            border-radius: 2px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .info {
            color: blue;
        }
        .session-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>会话系统修复测试</h1>
        
        <div class="test-section">
            <h2>1. 客户端会话ID测试</h2>
            <button onclick="testClientSessionId()">测试客户端会话ID</button>
            <button onclick="clearClientSessionId()">清除客户端会话ID</button>
            <div id="clientSessionLog" class="log-container"></div>
        </div>

        <div class="test-section">
            <h2>2. 创建测试会话</h2>
            <button onclick="createTestSession()">创建新会话</button>
            <button onclick="createMultipleSessions()">创建多个测试会话</button>
            <div id="createSessionLog" class="log-container"></div>
        </div>

        <div class="test-section">
            <h2>3. 数据迁移测试</h2>
            <button onclick="testMigration()">测试数据迁移</button>
            <button onclick="createLocalData()">创建本地测试数据</button>
            <div id="migrationLog" class="log-container"></div>
        </div>

        <div class="test-section">
            <h2>4. 获取会话列表</h2>
            <button onclick="loadSessions()">加载会话列表</button>
            <div id="sessionsLog" class="log-container"></div>
            <div id="sessionsList"></div>
        </div>
    </div>

    <script>
        // 日志函数
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        // 客户端会话ID管理
        function getClientSessionId() {
            let sessionId = localStorage.getItem('client_session_id');
            if (!sessionId) {
                sessionId = `client_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('client_session_id', sessionId);
            }
            return sessionId;
        }

        function addClientSessionHeader(headers = {}) {
            const sessionId = getClientSessionId();
            return {
                ...headers,
                'X-Client-Session-Id': sessionId
            };
        }

        // 测试客户端会话ID
        async function testClientSessionId() {
            const logId = 'clientSessionLog';
            try {
                const sessionId = getClientSessionId();
                log(logId, `当前客户端会话ID: ${sessionId}`, 'success');
                
                // 检查localStorage
                const storedId = localStorage.getItem('client_session_id');
                log(logId, `localStorage中的ID: ${storedId}`, 'info');
                
                // 测试API调用是否包含header
                const headers = addClientSessionHeader();
                log(logId, `API请求头: ${JSON.stringify(headers)}`, 'info');
            } catch (error) {
                log(logId, `错误: ${error.message}`, 'error');
            }
        }

        function clearClientSessionId() {
            localStorage.removeItem('client_session_id');
            log('clientSessionLog', '客户端会话ID已清除', 'success');
        }

        // 创建测试会话
        async function createTestSession() {
            const logId = 'createSessionLog';
            try {
                log(logId, '开始创建测试会话...', 'info');
                
                const response = await fetch('/api/exams/sessions', {
                    method: 'POST',
                    headers: addClientSessionHeader({
                        'Content-Type': 'application/json',
                    }),
                    body: JSON.stringify({
                        filters: {
                            subject: '民法',
                            years: ['2023', '2022'],
                            types: ['单项选择题'],
                            search: ''
                        },
                        totalQuestions: 50,
                        source: 'all'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    log(logId, `会话创建成功: ${JSON.stringify(result.data)}`, 'success');
                    
                    // 模拟更新会话
                    setTimeout(async () => {
                        await updateTestSession(result.data.sessionId);
                    }, 1000);
                } else {
                    const error = await response.text();
                    log(logId, `创建失败: ${error}`, 'error');
                }
            } catch (error) {
                log(logId, `错误: ${error.message}`, 'error');
            }
        }

        async function updateTestSession(sessionId) {
            const logId = 'createSessionLog';
            try {
                log(logId, `更新会话 ${sessionId}...`, 'info');
                
                const response = await fetch('/api/exams/sessions', {
                    method: 'PUT',
                    headers: addClientSessionHeader({
                        'Content-Type': 'application/json',
                    }),
                    body: JSON.stringify({
                        sessionId: sessionId,
                        updates: {
                            questionsAnswered: 10,
                            correctCount: 7,
                            lastQuestionId: 10,
                            endTime: new Date().toISOString()
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    log(logId, `会话更新成功`, 'success');
                } else {
                    const error = await response.text();
                    log(logId, `更新失败: ${error}`, 'error');
                }
            } catch (error) {
                log(logId, `错误: ${error.message}`, 'error');
            }
        }

        // 创建多个测试会话
        async function createMultipleSessions() {
            const logId = 'createSessionLog';
            const subjects = ['民法', '刑法', '行政法'];
            const years = [['2023'], ['2022'], ['2021', '2022']];
            
            for (let i = 0; i < 3; i++) {
                const sessionData = {
                    filters: {
                        subject: subjects[i],
                        years: years[i],
                        types: ['单项选择题'],
                        search: ''
                    },
                    totalQuestions: 30 + i * 10,
                    source: i === 2 ? 'wrong' : 'all'
                };
                
                log(logId, `创建会话 ${i + 1}/3...`, 'info');
                
                try {
                    const response = await fetch('/api/exams/sessions', {
                        method: 'POST',
                        headers: addClientSessionHeader({
                            'Content-Type': 'application/json',
                        }),
                        body: JSON.stringify(sessionData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        log(logId, `会话 ${i + 1} 创建成功`, 'success');
                        
                        // 模拟答题
                        await updateTestSession(result.data.sessionId);
                    }
                } catch (error) {
                    log(logId, `创建会话 ${i + 1} 失败: ${error.message}`, 'error');
                }
                
                // 延迟避免太快
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        // 创建本地测试数据
        function createLocalData() {
            const logId = 'migrationLog';
            try {
                // 创建测试会话数据
                const testSessions = [
                    {
                        sessionId: `local_${Date.now()}_1`,
                        startTime: new Date(Date.now() - 3600000).toISOString(),
                        endTime: new Date(Date.now() - 1800000).toISOString(),
                        questionsAnswered: 25,
                        correctCount: 20,
                        totalQuestions: 30,
                        source: 'all',
                        filters: {
                            subject: '民法',
                            years: ['2023'],
                            types: ['单项选择题']
                        }
                    },
                    {
                        sessionId: `local_${Date.now()}_2`,
                        startTime: new Date(Date.now() - 7200000).toISOString(),
                        endTime: new Date(Date.now() - 5400000).toISOString(),
                        questionsAnswered: 15,
                        correctCount: 12,
                        totalQuestions: 20,
                        source: 'wrong',
                        filters: {
                            subject: '刑法',
                            years: ['2022'],
                            types: ['多项选择题']
                        }
                    }
                ];
                
                // 保存到localStorage
                localStorage.setItem('answerSessions', JSON.stringify(testSessions));
                
                // 创建当前会话
                const currentSession = {
                    sessionId: `current_${Date.now()}`,
                    startTime: new Date().toISOString(),
                    questionsAnswered: 5,
                    correctCount: 3,
                    totalQuestions: 50,
                    source: 'all',
                    filters: {
                        subject: '行政法',
                        years: ['2023', '2022'],
                        types: ['单项选择题']
                    }
                };
                localStorage.setItem('currentAnswerSession', JSON.stringify(currentSession));
                
                // 清除迁移标记
                localStorage.removeItem('answerHistoryMigrated');
                
                log(logId, '本地测试数据创建成功', 'success');
                log(logId, `创建了 ${testSessions.length} 个历史会话`, 'info');
                log(logId, '创建了 1 个当前会话', 'info');
            } catch (error) {
                log(logId, `创建本地数据失败: ${error.message}`, 'error');
            }
        }

        // 测试数据迁移
        async function testMigration() {
            const logId = 'migrationLog';
            try {
                log(logId, '开始数据迁移...', 'info');
                
                // 获取本地数据
                const sessionsStr = localStorage.getItem('answerSessions');
                const currentSessionStr = localStorage.getItem('currentAnswerSession');
                const historyStr = localStorage.getItem('answerHistory');
                
                const sessions = sessionsStr ? JSON.parse(sessionsStr) : [];
                const currentSession = currentSessionStr ? JSON.parse(currentSessionStr) : null;
                const answerHistory = historyStr ? JSON.parse(historyStr) : null;
                
                log(logId, `找到 ${sessions.length} 个历史会话`, 'info');
                log(logId, `当前会话: ${currentSession ? '有' : '无'}`, 'info');
                log(logId, `答题历史: ${answerHistory ? '有' : '无'}`, 'info');
                
                if (sessions.length === 0 && !currentSession && !answerHistory) {
                    log(logId, '没有需要迁移的数据', 'info');
                    return;
                }
                
                const response = await fetch('/api/exams/sessions/migrate', {
                    method: 'POST',
                    headers: addClientSessionHeader({
                        'Content-Type': 'application/json',
                    }),
                    body: JSON.stringify({
                        sessions,
                        currentSession,
                        answerHistory
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    log(logId, `迁移成功: 成功迁移 ${result.data.migratedCount} 个会话`, 'success');
                    log(logId, `客户端会话ID: ${result.data.clientSessionId}`, 'info');
                    if (result.data.errors && result.data.errors.length > 0) {
                        log(logId, `有 ${result.data.errors.length} 个错误:`, 'error');
                        result.data.errors.forEach(err => {
                            log(logId, `- ${err.sessionId}: ${err.error}`, 'error');
                        });
                    }
                    localStorage.setItem('answerHistoryMigrated', 'true');
                } else {
                    const error = await response.text();
                    log(logId, `迁移失败: ${error}`, 'error');
                }
            } catch (error) {
                log(logId, `错误: ${error.message}`, 'error');
            }
        }

        // 加载会话列表
        async function loadSessions() {
            const logId = 'sessionsLog';
            const listContainer = document.getElementById('sessionsList');
            
            try {
                log(logId, '正在加载会话列表...', 'info');
                
                const response = await fetch('/api/exams/sessions', {
                    headers: addClientSessionHeader()
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.data.sessions) {
                        const sessions = result.data.sessions;
                        log(logId, `成功加载 ${sessions.length} 个会话`, 'success');
                        log(logId, `客户端会话ID: ${result.data.clientSessionId}`, 'info');
                        
                        // 显示会话列表
                        listContainer.innerHTML = '';
                        sessions.forEach((session, index) => {
                            const sessionDiv = document.createElement('div');
                            sessionDiv.className = 'session-item';
                            sessionDiv.innerHTML = `
                                <strong>会话 ${index + 1}</strong> (ID: ${session.session_id})<br>
                                科目: ${session.subject || '未指定'} | 
                                来源: ${session.source || 'all'} | 
                                题数: ${session.questions_answered}/${session.total_questions || '?'} | 
                                正确率: ${session.accuracy_rate || 0}%<br>
                                开始时间: ${new Date(session.start_time).toLocaleString('zh-CN')}
                            `;
                            listContainer.appendChild(sessionDiv);
                        });
                    } else {
                        log(logId, '没有找到会话数据', 'info');
                    }
                } else {
                    const error = await response.text();
                    log(logId, `加载失败: ${error}`, 'error');
                }
            } catch (error) {
                log(logId, `错误: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动测试客户端会话ID
        window.onload = function() {
            testClientSessionId();
        };
    </script>
</body>
</html>