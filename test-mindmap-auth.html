<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试知识导图认证</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .info {
            color: blue;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>测试知识导图认证问题</h1>
    
    <div class="section">
        <h2>1. 检查本地存储的认证信息</h2>
        <button onclick="checkLocalAuth()">检查认证信息</button>
        <div id="authInfo"></div>
    </div>
    
    <div class="section">
        <h2>2. 测试访问民法（免费）</h2>
        <button onclick="testMindMap('民法')">访问民法</button>
        <div id="minfa-result"></div>
    </div>
    
    <div class="section">
        <h2>3. 测试访问刑法（需要会员）</h2>
        <button onclick="testMindMap('刑法')">访问刑法</button>
        <div id="xingfa-result"></div>
    </div>
    
    <div class="section">
        <h2>4. 模拟登录（创建测试Token）</h2>
        <button onclick="simulateLogin()">模拟登录</button>
        <div id="login-result"></div>
    </div>

    <script>
        // 检查本地认证信息
        function checkLocalAuth() {
            const authToken = localStorage.getItem('auth_token');
            const userInfo = localStorage.getItem('user_info');
            const resultDiv = document.getElementById('authInfo');
            
            let html = '<h3>本地存储信息：</h3>';
            
            if (authToken) {
                html += '<p class="success">✓ 找到 auth_token</p>';
                html += `<pre>Token前50字符: ${authToken.substring(0, 50)}...</pre>`;
                
                // 尝试解析JWT
                try {
                    const parts = authToken.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1]));
                        html += '<p class="info">Token 载荷:</p>';
                        html += `<pre>${JSON.stringify(payload, null, 2)}</pre>`;
                    }
                } catch (e) {
                    html += '<p class="error">无法解析 JWT token</p>';
                }
            } else {
                html += '<p class="error">✗ 未找到 auth_token</p>';
            }
            
            if (userInfo) {
                html += '<p class="success">✓ 找到 user_info</p>';
                try {
                    const user = JSON.parse(userInfo);
                    html += `<pre>${JSON.stringify(user, null, 2)}</pre>`;
                } catch (e) {
                    html += '<p class="error">无法解析 user_info</p>';
                }
            } else {
                html += '<p class="error">✗ 未找到 user_info</p>';
            }
            
            resultDiv.innerHTML = html;
        }
        
        // 测试访问知识导图
        async function testMindMap(subject) {
            const resultDiv = document.getElementById(`${subject === '民法' ? 'minfa' : 'xingfa'}-result`);
            resultDiv.innerHTML = '<p class="info">正在请求...</p>';
            
            const authToken = localStorage.getItem('auth_token');
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
                console.log('发送的Authorization头:', headers['Authorization']);
            }
            
            try {
                const response = await fetch(`/api/mindmaps/${encodeURIComponent(subject)}`, {
                    method: 'GET',
                    headers: headers
                });
                
                const data = await response.json();
                
                let html = `<h3>响应状态: ${response.status}</h3>`;
                
                if (response.ok) {
                    html += '<p class="success">✓ 访问成功</p>';
                    html += '<p>返回了知识导图数据</p>';
                } else {
                    html += '<p class="error">✗ 访问失败</p>';
                    html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    
                    if (data.upgradeRequired) {
                        html += '<p class="info">需要升级权限</p>';
                        html += `<p>requireAuth: ${data.requireAuth}</p>`;
                        html += `<p>应该显示: ${data.requireAuth ? '立即登录' : '升级会员'} 按钮</p>`;
                    }
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">请求失败: ${error.message}</p>`;
            }
        }
        
        // 模拟登录
        function simulateLogin() {
            const resultDiv = document.getElementById('login-result');
            
            // 创建一个模拟的JWT token
            const header = {
                alg: 'HS256',
                typ: 'JWT'
            };
            
            const payload = {
                user_id: 1,
                phone_number: '13800138000',
                membership_type: 'free',
                iat: Math.floor(Date.now() / 1000),
                exp: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60) // 7天后过期
            };
            
            // 这只是一个模拟token，实际应该由服务器生成
            const mockToken = btoa(JSON.stringify(header)) + '.' + 
                             btoa(JSON.stringify(payload)) + '.' + 
                             'mock-signature';
            
            const mockUser = {
                user_id: 1,
                phone_number: '13800138000',
                membership_type: 'free',
                nickname: '测试用户'
            };
            
            localStorage.setItem('auth_token', mockToken);
            localStorage.setItem('user_info', JSON.stringify(mockUser));
            
            resultDiv.innerHTML = `
                <p class="success">✓ 已模拟登录</p>
                <p>用户信息:</p>
                <pre>${JSON.stringify(mockUser, null, 2)}</pre>
                <p class="info">注意: 这只是模拟token，后端验证会失败</p>
            `;
        }
        
        // 页面加载时自动检查
        window.onload = function() {
            checkLocalAuth();
        };
    </script>
</body>
</html>