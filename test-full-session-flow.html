<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´ä¼šè¯æµç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            margin-top: 0;
            color: #333;
        }
        pre {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .log-entry.error {
            color: red;
        }
        .log-entry.success {
            color: green;
        }
        .log-entry.info {
            color: blue;
        }
    </style>
</head>
<body>
    <h1>å®Œæ•´ä¼šè¯æµç¨‹æµ‹è¯•</h1>
    
    <div class="section">
        <h2>æ¨¡æ‹Ÿé”™é¢˜ç»ƒä¹ æµç¨‹</h2>
        <button onclick="simulateWrongQuestionsFlow()">è¿è¡Œé”™é¢˜ç»ƒä¹ æµç¨‹</button>
        <button onclick="simulateFavoritesFlow()">è¿è¡Œæ”¶è—ç»ƒä¹ æµç¨‹</button>
        <button onclick="simulateNormalFlow()">è¿è¡Œæ™®é€šç»ƒä¹ æµç¨‹</button>
        <button class="danger" onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        <div id="flowLog" class="log"></div>
    </div>
    
    <div class="section">
        <h2>å½“å‰çŠ¶æ€</h2>
        <button onclick="checkAllData()">æ£€æŸ¥æ‰€æœ‰æ•°æ®</button>
        <div id="currentStatus"></div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('flowLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        };
        
        // å¯¼å…¥answer-sessions.jsçš„å‡½æ•°
        function createAnswerSession(filters = {}, totalQuestions = 0, source = 'all') {
            const sessionId = Date.now().toString();
            const session = {
                sessionId,
                startTime: new Date().toISOString(),
                questionsAnswered: 0,
                correctCount: 0,
                totalQuestions: totalQuestions || 0,
                source: source,
                filters: {
                    subject: filters.subject || 'all',
                    years: filters.years || ['all'],
                    types: filters.types || ['å…¨éƒ¨é¢˜å‹'],
                    search: filters.search || ''
                },
                lastQuestionId: 1
            };
            
            localStorage.setItem('currentAnswerSession', JSON.stringify(session));
            log(`åˆ›å»º${source}ä¼šè¯: ${sessionId}`, 'success');
            return session;
        }
        
        function updateCurrentSession(updates) {
            try {
                const currentSessionStr = localStorage.getItem('currentAnswerSession');
                if (!currentSessionStr) {
                    log('æ²¡æœ‰å½“å‰ä¼šè¯å¯æ›´æ–°', 'error');
                    return;
                }
                
                const currentSession = JSON.parse(currentSessionStr);
                const updatedSession = {
                    ...currentSession,
                    ...updates
                };
                
                localStorage.setItem('currentAnswerSession', JSON.stringify(updatedSession));
                log(`æ›´æ–°ä¼šè¯: å·²ç­”${updates.questionsAnswered}é¢˜ï¼Œç­”å¯¹${updates.correctCount}é¢˜`, 'info');
                return updatedSession;
            } catch (error) {
                log('æ›´æ–°ä¼šè¯å¤±è´¥: ' + error.message, 'error');
                return null;
            }
        }
        
        function endCurrentSession() {
            try {
                const currentSessionStr = localStorage.getItem('currentAnswerSession');
                if (!currentSessionStr) {
                    log('æ²¡æœ‰å½“å‰ä¼šè¯éœ€è¦ç»“æŸ', 'error');
                    return;
                }
                
                const currentSession = JSON.parse(currentSessionStr);
                currentSession.endTime = new Date().toISOString();
                
                log(`ç»“æŸä¼šè¯ ${currentSession.sessionId}: ${currentSession.source}ç±»å‹ï¼Œå·²ç­”${currentSession.questionsAnswered}é¢˜`, 'info');
                
                // è·å–ç°æœ‰ä¼šè¯å†å²
                const sessionsStr = localStorage.getItem('answerSessions');
                let sessions = [];
                
                if (sessionsStr) {
                    try {
                        sessions = JSON.parse(sessionsStr);
                    } catch (e) {
                        log('è§£æä¼šè¯å†å²å¤±è´¥: ' + e.message, 'error');
                    }
                }
                
                // æ·»åŠ å½“å‰ä¼šè¯åˆ°å†å²
                sessions.push(currentSession);
                
                // ä¿ç•™æœ€è¿‘30ä¸ªä¼šè¯
                if (sessions.length > 30) {
                    sessions = sessions.slice(-30);
                }
                
                // ä¿å­˜æ›´æ–°åçš„ä¼šè¯å†å²
                localStorage.setItem('answerSessions', JSON.stringify(sessions));
                
                // æ¸…é™¤å½“å‰ä¼šè¯
                localStorage.removeItem('currentAnswerSession');
                
                // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
                window.dispatchEvent(new Event('answerSessionUpdated'));
                
                log('ä¼šè¯å·²ä¿å­˜åˆ°å†å²', 'success');
                return currentSession;
            } catch (error) {
                log('ç»“æŸä¼šè¯å¤±è´¥: ' + error.message, 'error');
                return null;
            }
        }
        
        // æ¨¡æ‹Ÿé”™é¢˜ç»ƒä¹ æµç¨‹
        async function simulateWrongQuestionsFlow() {
            log('=== å¼€å§‹é”™é¢˜ç»ƒä¹ æµç¨‹ ===', 'info');
            
            // 1. åˆ›å»ºé”™é¢˜ç»ƒä¹ ä¼šè¯
            createAnswerSession({}, 11, 'wrong');
            
            // 2. æ¨¡æ‹Ÿç­”é¢˜
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 1,
                correctCount: 0,
                lastQuestionId: 123
            });
            
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 2,
                correctCount: 1,
                lastQuestionId: 124
            });
            
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 3,
                correctCount: 2,
                lastQuestionId: 125
            });
            
            // 3. ç»“æŸä¼šè¯
            await sleep(500);
            endCurrentSession();
            
            log('=== é”™é¢˜ç»ƒä¹ æµç¨‹å®Œæˆ ===', 'success');
            checkAllData();
        }
        
        // æ¨¡æ‹Ÿæ”¶è—ç»ƒä¹ æµç¨‹
        async function simulateFavoritesFlow() {
            log('=== å¼€å§‹æ”¶è—ç»ƒä¹ æµç¨‹ ===', 'info');
            
            // 1. åˆ›å»ºæ”¶è—ç»ƒä¹ ä¼šè¯
            createAnswerSession({}, 8, 'favorites');
            
            // 2. æ¨¡æ‹Ÿç­”é¢˜
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 1,
                correctCount: 1,
                lastQuestionId: 456
            });
            
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 2,
                correctCount: 2,
                lastQuestionId: 457
            });
            
            // 3. ç»“æŸä¼šè¯
            await sleep(500);
            endCurrentSession();
            
            log('=== æ”¶è—ç»ƒä¹ æµç¨‹å®Œæˆ ===', 'success');
            checkAllData();
        }
        
        // æ¨¡æ‹Ÿæ™®é€šç»ƒä¹ æµç¨‹
        async function simulateNormalFlow() {
            log('=== å¼€å§‹æ™®é€šç»ƒä¹ æµç¨‹ ===', 'info');
            
            // 1. åˆ›å»ºæ™®é€šç»ƒä¹ ä¼šè¯
            createAnswerSession({
                subject: 'åˆ‘æ³•',
                years: ['2023', '2024'],
                types: ['å•é€‰é¢˜']
            }, 50, 'all');
            
            // 2. æ¨¡æ‹Ÿç­”é¢˜
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 1,
                correctCount: 1,
                lastQuestionId: 1
            });
            
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 2,
                correctCount: 1,
                lastQuestionId: 2
            });
            
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 3,
                correctCount: 2,
                lastQuestionId: 3
            });
            
            // 3. ç»“æŸä¼šè¯
            await sleep(500);
            endCurrentSession();
            
            log('=== æ™®é€šç»ƒä¹ æµç¨‹å®Œæˆ ===', 'success');
            checkAllData();
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function checkAllData() {
            const statusDiv = document.getElementById('currentStatus');
            let html = '<h3>å½“å‰æ•°æ®çŠ¶æ€</h3>';
            
            // æ£€æŸ¥å½“å‰ä¼šè¯
            const currentSession = localStorage.getItem('currentAnswerSession');
            if (currentSession) {
                html += '<h4>å½“å‰æ´»åŠ¨ä¼šè¯</h4>';
                html += '<pre>' + JSON.stringify(JSON.parse(currentSession), null, 2) + '</pre>';
            } else {
                html += '<p>æ²¡æœ‰æ´»åŠ¨ä¼šè¯</p>';
            }
            
            // æ£€æŸ¥ä¼šè¯å†å²
            const sessions = localStorage.getItem('answerSessions');
            if (sessions) {
                const sessionsData = JSON.parse(sessions);
                html += `<h4>ä¼šè¯å†å² (å…±${sessionsData.length}ä¸ª)</h4>`;
                
                // æŒ‰ç±»å‹åˆ†ç»„
                const wrongSessions = sessionsData.filter(s => s.source === 'wrong');
                const favoritesSessions = sessionsData.filter(s => s.source === 'favorites');
                const normalSessions = sessionsData.filter(s => !s.source || s.source === 'all');
                
                html += `<p>é”™é¢˜ä¼šè¯: ${wrongSessions.length}ä¸ª</p>`;
                html += `<p>æ”¶è—ä¼šè¯: ${favoritesSessions.length}ä¸ª</p>`;
                html += `<p>æ™®é€šä¼šè¯: ${normalSessions.length}ä¸ª</p>`;
                
                // æ˜¾ç¤ºæœ€è¿‘5ä¸ªä¼šè¯
                html += '<h5>æœ€è¿‘5ä¸ªä¼šè¯ï¼š</h5>';
                const recentSessions = sessionsData.slice(-5).reverse();
                recentSessions.forEach((session, index) => {
                    const icon = session.source === 'wrong' ? 'ğŸ”´' : 
                                session.source === 'favorites' ? 'â­' : 'ğŸ“';
                    html += `<div style="margin-bottom: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px;">`;
                    html += `<strong>${icon} ${session.source || 'all'}</strong> - `;
                    html += `å·²ç­”${session.questionsAnswered}/${session.totalQuestions || '?'}é¢˜ï¼Œ`;
                    html += `æ­£ç¡®ç‡${session.questionsAnswered > 0 ? Math.round((session.correctCount / session.questionsAnswered) * 100) : 0}%`;
                    html += `<br><small>${new Date(session.startTime).toLocaleString()}</small>`;
                    html += `</div>`;
                });
                
                html += '<details><summary>æŸ¥çœ‹å®Œæ•´æ•°æ®</summary>';
                html += '<pre>' + JSON.stringify(sessionsData, null, 2) + '</pre>';
                html += '</details>';
            } else {
                html += '<p>æ²¡æœ‰ä¼šè¯å†å²</p>';
            }
            
            statusDiv.innerHTML = html;
        }
        
        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¼šè¯æ•°æ®å—ï¼Ÿ')) {
                localStorage.removeItem('currentAnswerSession');
                localStorage.removeItem('answerSessions');
                log('å·²æ¸…ç©ºæ‰€æœ‰ä¼šè¯æ•°æ®', 'success');
                checkAllData();
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.onload = function() {
            checkAllData();
        };
    </script>
</body>
</html>