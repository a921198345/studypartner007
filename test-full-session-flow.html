<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整会话流程测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            margin-top: 0;
            color: #333;
        }
        pre {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .log-entry.error {
            color: red;
        }
        .log-entry.success {
            color: green;
        }
        .log-entry.info {
            color: blue;
        }
    </style>
</head>
<body>
    <h1>完整会话流程测试</h1>
    
    <div class="section">
        <h2>模拟错题练习流程</h2>
        <button onclick="simulateWrongQuestionsFlow()">运行错题练习流程</button>
        <button onclick="simulateFavoritesFlow()">运行收藏练习流程</button>
        <button onclick="simulateNormalFlow()">运行普通练习流程</button>
        <button class="danger" onclick="clearAll()">清空所有数据</button>
        <div id="flowLog" class="log"></div>
    </div>
    
    <div class="section">
        <h2>当前状态</h2>
        <button onclick="checkAllData()">检查所有数据</button>
        <div id="currentStatus"></div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('flowLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        };
        
        // 导入answer-sessions.js的函数
        function createAnswerSession(filters = {}, totalQuestions = 0, source = 'all') {
            const sessionId = Date.now().toString();
            const session = {
                sessionId,
                startTime: new Date().toISOString(),
                questionsAnswered: 0,
                correctCount: 0,
                totalQuestions: totalQuestions || 0,
                source: source,
                filters: {
                    subject: filters.subject || 'all',
                    years: filters.years || ['all'],
                    types: filters.types || ['全部题型'],
                    search: filters.search || ''
                },
                lastQuestionId: 1
            };
            
            localStorage.setItem('currentAnswerSession', JSON.stringify(session));
            log(`创建${source}会话: ${sessionId}`, 'success');
            return session;
        }
        
        function updateCurrentSession(updates) {
            try {
                const currentSessionStr = localStorage.getItem('currentAnswerSession');
                if (!currentSessionStr) {
                    log('没有当前会话可更新', 'error');
                    return;
                }
                
                const currentSession = JSON.parse(currentSessionStr);
                const updatedSession = {
                    ...currentSession,
                    ...updates
                };
                
                localStorage.setItem('currentAnswerSession', JSON.stringify(updatedSession));
                log(`更新会话: 已答${updates.questionsAnswered}题，答对${updates.correctCount}题`, 'info');
                return updatedSession;
            } catch (error) {
                log('更新会话失败: ' + error.message, 'error');
                return null;
            }
        }
        
        function endCurrentSession() {
            try {
                const currentSessionStr = localStorage.getItem('currentAnswerSession');
                if (!currentSessionStr) {
                    log('没有当前会话需要结束', 'error');
                    return;
                }
                
                const currentSession = JSON.parse(currentSessionStr);
                currentSession.endTime = new Date().toISOString();
                
                log(`结束会话 ${currentSession.sessionId}: ${currentSession.source}类型，已答${currentSession.questionsAnswered}题`, 'info');
                
                // 获取现有会话历史
                const sessionsStr = localStorage.getItem('answerSessions');
                let sessions = [];
                
                if (sessionsStr) {
                    try {
                        sessions = JSON.parse(sessionsStr);
                    } catch (e) {
                        log('解析会话历史失败: ' + e.message, 'error');
                    }
                }
                
                // 添加当前会话到历史
                sessions.push(currentSession);
                
                // 保留最近30个会话
                if (sessions.length > 30) {
                    sessions = sessions.slice(-30);
                }
                
                // 保存更新后的会话历史
                localStorage.setItem('answerSessions', JSON.stringify(sessions));
                
                // 清除当前会话
                localStorage.removeItem('currentAnswerSession');
                
                // 触发自定义事件
                window.dispatchEvent(new Event('answerSessionUpdated'));
                
                log('会话已保存到历史', 'success');
                return currentSession;
            } catch (error) {
                log('结束会话失败: ' + error.message, 'error');
                return null;
            }
        }
        
        // 模拟错题练习流程
        async function simulateWrongQuestionsFlow() {
            log('=== 开始错题练习流程 ===', 'info');
            
            // 1. 创建错题练习会话
            createAnswerSession({}, 11, 'wrong');
            
            // 2. 模拟答题
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 1,
                correctCount: 0,
                lastQuestionId: 123
            });
            
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 2,
                correctCount: 1,
                lastQuestionId: 124
            });
            
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 3,
                correctCount: 2,
                lastQuestionId: 125
            });
            
            // 3. 结束会话
            await sleep(500);
            endCurrentSession();
            
            log('=== 错题练习流程完成 ===', 'success');
            checkAllData();
        }
        
        // 模拟收藏练习流程
        async function simulateFavoritesFlow() {
            log('=== 开始收藏练习流程 ===', 'info');
            
            // 1. 创建收藏练习会话
            createAnswerSession({}, 8, 'favorites');
            
            // 2. 模拟答题
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 1,
                correctCount: 1,
                lastQuestionId: 456
            });
            
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 2,
                correctCount: 2,
                lastQuestionId: 457
            });
            
            // 3. 结束会话
            await sleep(500);
            endCurrentSession();
            
            log('=== 收藏练习流程完成 ===', 'success');
            checkAllData();
        }
        
        // 模拟普通练习流程
        async function simulateNormalFlow() {
            log('=== 开始普通练习流程 ===', 'info');
            
            // 1. 创建普通练习会话
            createAnswerSession({
                subject: '刑法',
                years: ['2023', '2024'],
                types: ['单选题']
            }, 50, 'all');
            
            // 2. 模拟答题
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 1,
                correctCount: 1,
                lastQuestionId: 1
            });
            
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 2,
                correctCount: 1,
                lastQuestionId: 2
            });
            
            await sleep(500);
            updateCurrentSession({
                questionsAnswered: 3,
                correctCount: 2,
                lastQuestionId: 3
            });
            
            // 3. 结束会话
            await sleep(500);
            endCurrentSession();
            
            log('=== 普通练习流程完成 ===', 'success');
            checkAllData();
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function checkAllData() {
            const statusDiv = document.getElementById('currentStatus');
            let html = '<h3>当前数据状态</h3>';
            
            // 检查当前会话
            const currentSession = localStorage.getItem('currentAnswerSession');
            if (currentSession) {
                html += '<h4>当前活动会话</h4>';
                html += '<pre>' + JSON.stringify(JSON.parse(currentSession), null, 2) + '</pre>';
            } else {
                html += '<p>没有活动会话</p>';
            }
            
            // 检查会话历史
            const sessions = localStorage.getItem('answerSessions');
            if (sessions) {
                const sessionsData = JSON.parse(sessions);
                html += `<h4>会话历史 (共${sessionsData.length}个)</h4>`;
                
                // 按类型分组
                const wrongSessions = sessionsData.filter(s => s.source === 'wrong');
                const favoritesSessions = sessionsData.filter(s => s.source === 'favorites');
                const normalSessions = sessionsData.filter(s => !s.source || s.source === 'all');
                
                html += `<p>错题会话: ${wrongSessions.length}个</p>`;
                html += `<p>收藏会话: ${favoritesSessions.length}个</p>`;
                html += `<p>普通会话: ${normalSessions.length}个</p>`;
                
                // 显示最近5个会话
                html += '<h5>最近5个会话：</h5>';
                const recentSessions = sessionsData.slice(-5).reverse();
                recentSessions.forEach((session, index) => {
                    const icon = session.source === 'wrong' ? '🔴' : 
                                session.source === 'favorites' ? '⭐' : '📝';
                    html += `<div style="margin-bottom: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px;">`;
                    html += `<strong>${icon} ${session.source || 'all'}</strong> - `;
                    html += `已答${session.questionsAnswered}/${session.totalQuestions || '?'}题，`;
                    html += `正确率${session.questionsAnswered > 0 ? Math.round((session.correctCount / session.questionsAnswered) * 100) : 0}%`;
                    html += `<br><small>${new Date(session.startTime).toLocaleString()}</small>`;
                    html += `</div>`;
                });
                
                html += '<details><summary>查看完整数据</summary>';
                html += '<pre>' + JSON.stringify(sessionsData, null, 2) + '</pre>';
                html += '</details>';
            } else {
                html += '<p>没有会话历史</p>';
            }
            
            statusDiv.innerHTML = html;
        }
        
        function clearAll() {
            if (confirm('确定要清空所有会话数据吗？')) {
                localStorage.removeItem('currentAnswerSession');
                localStorage.removeItem('answerSessions');
                log('已清空所有会话数据', 'success');
                checkAllData();
            }
        }
        
        // 页面加载时检查状态
        window.onload = function() {
            checkAllData();
        };
    </script>
</body>
</html>