import { NextRequest, NextResponse } from 'next/server'
import { getDeepSeekCompletion } from '@/lib/deepseek'

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    
    console.log('å¼€å§‹ç”Ÿæˆå­¦ä¹ è®¡åˆ’ï¼Œç”¨æˆ·æ•°æ®:', JSON.stringify(body, null, 2))

    // è°ƒç”¨DeepSeek APIç”Ÿæˆå­¦ä¹ è®¡åˆ’
    const aiPlan = await generateAIPlan(body)
    
    console.log('å­¦ä¹ è®¡åˆ’ç”ŸæˆæˆåŠŸ')
    
    return NextResponse.json({
      success: true,
      data: aiPlan
    })

  } catch (error) {
    console.error('ç”Ÿæˆå­¦ä¹ è®¡åˆ’å¤±è´¥:', error)
    
    // è¿”å›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
    return NextResponse.json(
      { 
        success: false, 
        error: error.message || 'ç”Ÿæˆå­¦ä¹ è®¡åˆ’å¤±è´¥',
        details: error.stack
      },
      { status: 500 }
    )
  }
}

async function generateAIPlan(formData: any) {
  try {
    // éªŒè¯è¾“å…¥æ•°æ®
    if (!formData.subject_progress || Object.keys(formData.subject_progress).length === 0) {
      throw new Error('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç§‘ç›®çš„å­¦ä¹ è¿›åº¦')
    }
    
    if (!formData.study_schedule || !formData.study_schedule.daily_hours) {
      throw new Error('è¯·è®¾ç½®æ¯æ—¥å­¦ä¹ æ—¶é•¿')
    }
    
    console.log('æ„å»ºAIæç¤ºè¯...')
    
    // æ„å»ºä¸“ä¸šçš„å­¦ä¹ è®¡åˆ’ç”Ÿæˆæç¤ºè¯
    const prompt = buildEnhancedPrompt(formData)
    
    console.log('è°ƒç”¨DeepSeek API...')
    
    // ä½¿ç”¨ä¼˜åŒ–åçš„DeepSeek APIè°ƒç”¨
    const aiResponse = await getDeepSeekCompletion(prompt)
    
    if (!aiResponse) {
      throw new Error('AIæœåŠ¡è¿”å›ç©ºå“åº”')
    }
    
    console.log('è§£æAIå“åº”...')
    
    // è§£æAIå“åº”å¹¶ç»“æ„åŒ–
    const parsedPlan = parseAIResponse(aiResponse, formData)
    
    console.log('å­¦ä¹ è®¡åˆ’è§£æå®Œæˆ')
    
    return parsedPlan
    
  } catch (error) {
    console.error('ç”ŸæˆAIå­¦ä¹ è®¡åˆ’å¤±è´¥:', error)
    throw new Error(`AIç”Ÿæˆå¤±è´¥: ${error.message}`)
  }
}

function buildEnhancedPrompt(formData: any) {
  const { subject_progress, subject_order, study_schedule, exam_date, calculated_total_hours, custom_notes } = formData
  
  // è®¡ç®—å­¦ä¹ ç»Ÿè®¡
  const activeSubjects = subject_order.map((item: any) => {
    const progress = subject_progress[item.subject]
    return {
      subject: item.subject,
      status: progress?.status || 'not_started',
      progress: progress?.progress || 0,
      chapters: progress?.chapters || [],
      completedSections: progress?.completedSections || []
    }
  })

  // è®¡ç®—è·ç¦»æ³•è€ƒçš„å¤©æ•°
  const today = new Date()
  const examDay = new Date(exam_date)
  const daysToExam = Math.max(0, Math.ceil((examDay.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)))

  // ç­›é€‰éœ€è¦å­¦ä¹ çš„ç§‘ç›®ï¼ˆæŒ‰ä¼˜å…ˆçº§é¡ºåºï¼‰
  const subjectsToStudy = activeSubjects.filter(s => s.status !== 'completed')
  
  // å½“å‰æ­£åœ¨å­¦ä¹ çš„ç§‘ç›®ï¼ˆç¬¬ä¸€ä¸ªæœªå®Œæˆçš„ç§‘ç›®ï¼‰
  const currentSubject = subjectsToStudy[0]
  
  // ä¸‹ä¸€ä¸ªè¦å­¦ä¹ çš„ç§‘ç›®
  const nextSubject = subjectsToStudy[1]

  const prompt = `# æ³•è€ƒå­¦ä¹ è®¡åˆ’å®šåˆ¶ä¸“å®¶

ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ³•è€ƒè¾…å¯¼ä¸“å®¶ï¼Œå…·æœ‰å¤šå¹´çš„æ³•è€ƒåŸ¹è®­ç»éªŒã€‚è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è¦æ±‚ä¸ºå­¦ç”Ÿåˆ¶å®šä¸ªæ€§åŒ–çš„å­¦ä¹ è®¡åˆ’ã€‚

## ğŸ¯ æ ¸å¿ƒå­¦ä¹ åŸåˆ™

### â­ é‡è¦åŸåˆ™ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
1. **ç§‘ç›®å®ŒæˆåŸåˆ™**ï¼šä¸€ä¸ªç§‘ç›®å®Œå…¨æŒæ¡åå†è¿›è¡Œä¸‹ä¸€ä¸ªç§‘ç›®
2. **å®¢è§‚é¢˜ä¼˜å…ˆ**ï¼šå®¢è§‚é¢˜å­¦ä¹ å 80%æ—¶é—´ï¼Œä¸»è§‚é¢˜å­¦ä¹ å 20%æ—¶é—´
3. **ä¸»è§‚é¢˜èåˆ**ï¼šä¸»è§‚é¢˜å­¦ä¹ ç©¿æ’åœ¨ç›¸å…³å®¢è§‚é¢˜å­¦ä¹ è¿‡ç¨‹ä¸­
4. **å…·ä½“åˆ°ç« èŠ‚**ï¼šè®¡åˆ’å¿…é¡»å…·ä½“åˆ°ç« èŠ‚ã€ä¸“é¢˜ã€çœŸé¢˜ç»ƒä¹ ï¼Œç»ä¸èƒ½ä½¿ç”¨"ç¬¬Xç« "è¿™æ ·çš„æ¨¡ç³Šæè¿°

## ğŸ“š å„ç§‘ç›®å…·ä½“ç« èŠ‚æ¡†æ¶ï¼ˆå¿…é¡»æŒ‰æ­¤æ¥åˆ¶å®šè®¡åˆ’ï¼‰ï¼š

### æ°‘æ³•å…¸ç« èŠ‚ï¼š
- æ€»åˆ™ç¼–ï¼šç¬¬ä¸€ç« è‡ªç„¶äººã€ç¬¬äºŒç« æ³•äººã€ç¬¬ä¸‰ç« éæ³•äººç»„ç»‡ã€ç¬¬å››ç« æ°‘äº‹æƒåˆ©ã€ç¬¬äº”ç« æ°‘äº‹æ³•å¾‹è¡Œä¸ºã€ç¬¬å…­ç« ä»£ç†ã€ç¬¬ä¸ƒç« æ°‘äº‹è´£ä»»ã€ç¬¬å…«ç« è¯‰è®¼æ—¶æ•ˆã€ç¬¬ä¹ç« æœŸé—´è®¡ç®—
- ç‰©æƒç¼–ï¼šç¬¬ä¸€ç« é€šåˆ™ã€ç¬¬äºŒç« æ‰€æœ‰æƒã€ç¬¬ä¸‰ç« ç”¨ç›Šç‰©æƒã€ç¬¬å››ç« æ‹…ä¿ç‰©æƒ
- åˆåŒç¼–ï¼šç¬¬ä¸€ç« é€šåˆ™ã€ç¬¬äºŒç« åˆåŒçš„è®¢ç«‹ã€ç¬¬ä¸‰ç« åˆåŒçš„æ•ˆåŠ›ã€ç¬¬å››ç« åˆåŒçš„å±¥è¡Œã€ç¬¬äº”ç« åˆåŒçš„ä¿å…¨ã€ç¬¬å…­ç« åˆåŒçš„å˜æ›´å’Œè½¬è®©ã€ç¬¬ä¸ƒç« åˆåŒçš„æƒåˆ©ä¹‰åŠ¡ç»ˆæ­¢ã€ç¬¬å…«ç« è¿çº¦è´£ä»»ã€ç¬¬ä¹ç« å‡†åˆåŒ
- äººæ ¼æƒç¼–ï¼šç¬¬ä¸€ç« ä¸€èˆ¬è§„å®šã€ç¬¬äºŒç« ç”Ÿå‘½æƒèº«ä½“æƒå¥åº·æƒã€ç¬¬ä¸‰ç« å§“åæƒå’Œåç§°æƒã€ç¬¬å››ç« è‚–åƒæƒã€ç¬¬äº”ç« åèª‰æƒå’Œè£èª‰æƒã€ç¬¬å…­ç« éšç§æƒå’Œä¸ªäººä¿¡æ¯ä¿æŠ¤
- å©šå§»å®¶åº­ç¼–ï¼šç¬¬ä¸€ç« ä¸€èˆ¬è§„å®šã€ç¬¬äºŒç« ç»“å©šã€ç¬¬ä¸‰ç« å®¶åº­å…³ç³»ã€ç¬¬å››ç« ç¦»å©šã€ç¬¬äº”ç« æ”¶å…»
- ç»§æ‰¿ç¼–ï¼šç¬¬ä¸€ç« ä¸€èˆ¬è§„å®šã€ç¬¬äºŒç« æ³•å®šç»§æ‰¿ã€ç¬¬ä¸‰ç« é—å˜±ç»§æ‰¿å’Œé—èµ ã€ç¬¬å››ç« é—äº§çš„å¤„ç†

### åˆ‘æ³•ç« èŠ‚ï¼š
- æ€»åˆ™ï¼šç¬¬ä¸€ç« åˆ‘æ³•çš„ä»»åŠ¡åŸºæœ¬åŸåˆ™å’Œé€‚ç”¨èŒƒå›´ã€ç¬¬äºŒç« çŠ¯ç½ªã€ç¬¬ä¸‰ç« åˆ‘ç½š
- åˆ†åˆ™ï¼šç¬¬ä¸€ç« å±å®³å›½å®¶å®‰å…¨ç½ªã€ç¬¬äºŒç« å±å®³å…¬å…±å®‰å…¨ç½ªã€ç¬¬ä¸‰ç« ç ´åç¤¾ä¼šä¸»ä¹‰å¸‚åœºç»æµç§©åºç½ªã€ç¬¬å››ç« ä¾µçŠ¯å…¬æ°‘äººèº«æƒåˆ©æ°‘ä¸»æƒåˆ©ç½ªã€ç¬¬äº”ç« ä¾µçŠ¯è´¢äº§ç½ªã€ç¬¬å…­ç« å¦¨å®³ç¤¾ä¼šç®¡ç†ç§©åºç½ªã€ç¬¬ä¸ƒç« å±å®³å›½é˜²åˆ©ç›Šç½ªã€ç¬¬å…«ç« è´ªæ±¡è´¿èµ‚ç½ªã€ç¬¬ä¹ç« æ¸èŒç½ªã€ç¬¬åç« å†›äººè¿åèŒè´£ç½ª

### è¡Œæ”¿æ³•ç« èŠ‚ï¼š
- ç¬¬ä¸€ç« è¡Œæ”¿æ³•åŸºæœ¬ç†è®ºã€ç¬¬äºŒç« è¡Œæ”¿æ³•ä¸»ä½“ã€ç¬¬ä¸‰ç« è¡Œæ”¿è¡Œä¸ºã€ç¬¬å››ç« è¡Œæ”¿ç¨‹åºã€ç¬¬äº”ç« è¡Œæ”¿å¤è®®ã€ç¬¬å…­ç« è¡Œæ”¿è¯‰è®¼ã€ç¬¬ä¸ƒç« è¡Œæ”¿èµ”å¿ã€ç¬¬å…«ç« ç›‘å¯Ÿæ³•

### æ°‘äº‹è¯‰è®¼æ³•ç« èŠ‚ï¼š
- ç¬¬ä¸€ç« æ€»åˆ™ã€ç¬¬äºŒç« ç®¡è¾–ã€ç¬¬ä¸‰ç« å®¡åˆ¤ç»„ç»‡ã€ç¬¬å››ç« å›é¿ã€ç¬¬äº”ç« è¯‰è®¼å‚åŠ äººã€ç¬¬å…­ç« è¯æ®ã€ç¬¬ä¸ƒç« æœŸé—´é€è¾¾ã€ç¬¬å…«ç« è°ƒè§£ã€ç¬¬ä¹ç« è´¢äº§ä¿å…¨å’Œå…ˆäºˆæ‰§è¡Œã€ç¬¬åç« å¯¹å¦¨å®³æ°‘äº‹è¯‰è®¼çš„å¼ºåˆ¶æªæ–½ã€ç¬¬åä¸€ç« è¯‰è®¼è´¹ç”¨

### åˆ‘äº‹è¯‰è®¼æ³•ç« èŠ‚ï¼š
- ç¬¬ä¸€ç« ä»»åŠ¡å’ŒåŸºæœ¬åŸåˆ™ã€ç¬¬äºŒç« ç®¡è¾–ã€ç¬¬ä¸‰ç« å›é¿ã€ç¬¬å››ç« è¾©æŠ¤ä¸ä»£ç†ã€ç¬¬äº”ç« è¯æ®ã€ç¬¬å…­ç« å¼ºåˆ¶æªæ–½ã€ç¬¬ä¸ƒç« é™„å¸¦æ°‘äº‹è¯‰è®¼ã€ç¬¬å…«ç« æœŸé—´é€è¾¾ã€ç¬¬ä¹ç« ç«‹æ¡ˆã€ç¬¬åç« ä¾¦æŸ¥ã€ç¬¬åä¸€ç« èµ·è¯‰ã€ç¬¬åäºŒç« å®¡åˆ¤ã€ç¬¬åä¸‰ç« æ‰§è¡Œ

### å•†ç»æ³•ç« èŠ‚ï¼š
- å…¬å¸æ³•ï¼šç¬¬ä¸€ç« æ€»åˆ™ã€ç¬¬äºŒç« æœ‰é™è´£ä»»å…¬å¸çš„è®¾ç«‹å’Œç»„ç»‡æœºæ„ã€ç¬¬ä¸‰ç« è‚¡ä»½æœ‰é™å…¬å¸çš„è®¾ç«‹å’Œç»„ç»‡æœºæ„ã€ç¬¬å››ç« è‚¡ä»½æœ‰é™å…¬å¸çš„è‚¡ä»½å‘è¡Œå’Œè½¬è®©ã€ç¬¬äº”ç« å…¬å¸è‘£äº‹ç›‘äº‹é«˜çº§ç®¡ç†äººå‘˜çš„èµ„æ ¼å’Œä¹‰åŠ¡ã€ç¬¬å…­ç« å…¬å¸å€ºåˆ¸ã€ç¬¬ä¸ƒç« å…¬å¸è´¢åŠ¡ä¼šè®¡ã€ç¬¬å…«ç« å…¬å¸åˆå¹¶åˆ†ç«‹å¢èµ„å‡èµ„ã€ç¬¬ä¹ç« å…¬å¸è§£æ•£å’Œæ¸…ç®—ã€ç¬¬åç« å¤–å›½å…¬å¸çš„åˆ†æ”¯æœºæ„
- åˆä¼™ä¼ä¸šæ³•ã€ä¸ªäººç‹¬èµ„ä¼ä¸šæ³•ã€ä¼ä¸šç ´äº§æ³•ã€è¯åˆ¸æ³•ã€ä¿é™©æ³•ã€ç¥¨æ®æ³•ã€åå„æ–­æ³•ã€åä¸æ­£å½“ç«äº‰æ³•ã€æ¶ˆè´¹è€…æƒç›Šä¿æŠ¤æ³•ã€äº§å“è´¨é‡æ³•

### ç†è®ºæ³•ç« èŠ‚ï¼š
- æ³•ç†å­¦ï¼šç¬¬ä¸€ç« æ³•å­¦å’Œæ³•ç†å­¦ã€ç¬¬äºŒç« æ³•çš„æœ¬è´¨ä¸ç‰¹å¾ã€ç¬¬ä¸‰ç« æ³•çš„èµ·æºä¸å‘å±•ã€ç¬¬å››ç« æ³•çš„ä½œç”¨ä¸ä»·å€¼ã€ç¬¬äº”ç« æ³•çš„æ¸Šæºå½¢å¼å’Œæ•ˆåŠ›ã€ç¬¬å…­ç« æ³•çš„è¦ç´ ã€ç¬¬ä¸ƒç« æ³•çš„ä½“ç³»ã€ç¬¬å…«ç« æ³•çš„è¿è¡Œã€ç¬¬ä¹ç« æ³•ä¸ç¤¾ä¼š
- å®ªæ³•ï¼šç¬¬ä¸€ç« å®ªæ³•åŸºæœ¬ç†è®ºã€ç¬¬äºŒç« å›½å®¶çš„åŸºæœ¬åˆ¶åº¦ã€ç¬¬ä¸‰ç« å…¬æ°‘çš„åŸºæœ¬æƒåˆ©å’Œä¹‰åŠ¡ã€ç¬¬å››ç« å›½å®¶æœºæ„
- æ³•åˆ¶å²ï¼šç¬¬ä¸€ç« ä¸­å›½æ³•åˆ¶å²ã€ç¬¬äºŒç« å¤–å›½æ³•åˆ¶å²

### ä¸‰å›½æ³•ç« èŠ‚ï¼š
- å›½é™…å…¬æ³•ï¼šç¬¬ä¸€ç« å¯¼è®ºã€ç¬¬äºŒç« å›½é™…æ³•ä¸»ä½“ã€ç¬¬ä¸‰ç« å›½å®¶é¢†åœŸã€ç¬¬å››ç« æµ·æ´‹æ³•ã€ç¬¬äº”ç« ç©ºé—´æ³•ã€ç¬¬å…­ç« å¤–äº¤å’Œé¢†äº‹å…³ç³»æ³•ã€ç¬¬ä¸ƒç« æ¡çº¦æ³•ã€ç¬¬å…«ç« å›½é™…äº‰ç«¯çš„å’Œå¹³è§£å†³ã€ç¬¬ä¹ç« æˆ˜äº‰ä¸æ­¦è£…å†²çªæ³•ã€ç¬¬åç« å›½é™…æ³•ä¸Šçš„ä¸ªäºº
- å›½é™…ç§æ³•ï¼šç¬¬ä¸€ç« æ€»è®ºã€ç¬¬äºŒç« å†²çªè§„èŒƒå’Œå‡†æ®æ³•ã€ç¬¬ä¸‰ç« é€‚ç”¨å†²çªè§„èŒƒçš„åˆ¶åº¦ã€ç¬¬å››ç« å›½é™…æ°‘å•†äº‹å…³ç³»çš„æ³•å¾‹é€‚ç”¨ã€ç¬¬äº”ç« å›½é™…æ°‘å•†äº‹äº‰è®®çš„è§£å†³ã€ç¬¬å…­ç« åŒºé™…æ³•å¾‹é—®é¢˜
- å›½é™…ç»æµæ³•ï¼šç¬¬ä¸€ç« å¯¼è®ºã€ç¬¬äºŒç« å›½é™…è´§ç‰©ä¹°å–æ³•ã€ç¬¬ä¸‰ç« å›½é™…è´§ç‰©è¿è¾“ä¸ä¿é™©æ³•ã€ç¬¬å››ç« å›½é™…è´¸æ˜“æ”¯ä»˜æ³•ã€ç¬¬äº”ç« ä¸–ç•Œè´¸æ˜“ç»„ç»‡æ³•ã€ç¬¬å…­ç« å›½é™…æŠ•èµ„æ³•ã€ç¬¬ä¸ƒç« å›½é™…é‡‘èæ³•ã€ç¬¬å…«ç« å›½é™…ç¨æ³•ã€ç¬¬ä¹ç« å›½é™…ç»æµäº‰è®®çš„è§£å†³

## ğŸ“Š å½“å‰å­¦ä¹ çŠ¶å†µ

### æ³•è€ƒå€’è®¡æ—¶
- **æ³•è€ƒæ—¥æœŸ**: ${exam_date}
- **å‰©ä½™å¤©æ•°**: ${daysToExam}å¤©
- **æ€»å­¦ä¹ æ—¶é•¿**: ${calculated_total_hours}å°æ—¶

### å­¦ä¹ æ—¶é—´å®‰æ’
- **æ¯æ—¥å­¦ä¹ æ—¶é•¿**: ${study_schedule.daily_hours}å°æ—¶ï¼ˆæ™ºèƒ½è®¡ç®—ï¼‰
- **æ¯å‘¨å­¦ä¹ å¤©æ•°**: ${study_schedule.weekly_days}å¤©
- **æ¯å‘¨æ€»å­¦æ—¶**: ${study_schedule.daily_hours * study_schedule.weekly_days}å°æ—¶

### ç§‘ç›®å­¦ä¹ çŠ¶æ€ï¼ˆæŒ‰ä¼˜å…ˆçº§é¡ºåºï¼‰
${activeSubjects.map((s, index) => {
  const statusText = s.status === 'in_progress' ? `è¿›è¡Œä¸­(${s.progress}%)` : 
                   s.status === 'not_started' ? 'æœªå¼€å§‹' : 'å·²å®Œæˆ(100%)'
  const isCurrentSubject = s.subject === currentSubject?.subject ? ' â† **å½“å‰é‡ç‚¹ç§‘ç›®**' : ''
  return `${index + 1}. **${s.subject}**: ${statusText}${isCurrentSubject}`
}).join('\n')}

### å½“å‰å­¦ä¹ é‡ç‚¹
- **ä¸»è¦ç§‘ç›®**: ${currentSubject?.subject || 'æ— '}
- **å­¦ä¹ è¿›åº¦**: ${currentSubject?.progress || 0}%
- **ä¸‹ä¸€ç§‘ç›®**: ${nextSubject?.subject || 'æ— '}

### ä¸ªäººå­¦ä¹ éœ€æ±‚
${custom_notes || 'æ— ç‰¹æ®Šè¦æ±‚'}

---

## ğŸ“ ç”Ÿæˆè¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è¦æ±‚å’Œæ ¼å¼ç”Ÿæˆå­¦ä¹ è®¡åˆ’ï¼š

### **æ€»ä½“è§„åˆ’æ€è·¯**
åˆ†æå½“å‰å­¦ä¹ çŠ¶å†µï¼Œåˆ¶å®šæ€»ä½“ç­–ç•¥ï¼š
- ğŸ“Š å½“å‰è¿›åº¦åˆ†æï¼šé’ˆå¯¹${currentSubject?.subject || 'ç¬¬ä¸€ç§‘ç›®'}çš„å­¦ä¹ çŠ¶æ€
- ğŸ¯ ç§‘ç›®å®Œæˆç­–ç•¥ï¼šä¸“æ³¨å½“å‰ç§‘ç›®ï¼Œä¸€ä¸ªç§‘ç›®å®Œå…¨æŒæ¡åå†è¿›è¡Œä¸‹ä¸€ä¸ª
- âš–ï¸ å®¢è§‚é¢˜80% + ä¸»è§‚é¢˜20%çš„æ—¶é—´åˆ†é…åŸåˆ™
- ğŸ“ˆ å…·ä½“åˆ°ç« èŠ‚ä¸“é¢˜çš„å­¦ä¹ è·¯å¾„è§„åˆ’

### **ä»Šæ—¥å­¦ä¹ è®¡åˆ’**
åˆ¶å®šä»Šå¤©çš„è¯¦ç»†å­¦ä¹ å®‰æ’ï¼ˆæ€»æ—¶é•¿${study_schedule.daily_hours}å°æ—¶ï¼‰ï¼Œä¸“æ³¨${currentSubject?.subject || 'å½“å‰ç§‘ç›®'}ï¼š

#### ğŸ¯ ä»Šæ—¥å­¦ä¹ ç›®æ ‡ (3åˆ†é’Ÿ)
- ğŸ“– æŸ¥çœ‹${currentSubject?.subject || 'å½“å‰ç§‘ç›®'}çŸ¥è¯†å¯¼å›¾ï¼Œäº†è§£ä»Šæ—¥å­¦ä¹ ç« èŠ‚åœ¨æ•´ä½“æ¡†æ¶ä¸­çš„ä½ç½®
- ğŸ” æ˜ç¡®ä»Šæ—¥å…·ä½“è¦æŒæ¡çš„ç« èŠ‚å’Œä¸“é¢˜

#### ğŸ“š å®¢è§‚é¢˜å­¦ä¹  (${Math.round(study_schedule.daily_hours * 60 * 0.8)}åˆ†é’Ÿ - 80%æ—¶é—´)
**å…·ä½“ç« èŠ‚å­¦ä¹ ï¼š**
- å¿…é¡»ä»ä¸Šè¿°ç« èŠ‚æ¡†æ¶ä¸­é€‰æ‹©${currentSubject?.subject || 'å½“å‰ç§‘ç›®'}çš„å…·ä½“ç« èŠ‚åç§°è¿›è¡Œå­¦ä¹ 
- é‡ç‚¹æ³•æ¡æ¢³ç†å’Œç†è§£
- é…å¥—æ•™æç²¾è¯»
- **çœŸé¢˜ç»ƒä¹ **ï¼šç»ƒä¹ è¯¥ç« èŠ‚å¯¹åº”çš„å†å¹´å®¢è§‚é¢˜çœŸé¢˜
- **çŸ¥è¯†å¯¼å›¾**ï¼šæŸ¥çœ‹å¯¹åº”ç« èŠ‚çš„çŸ¥è¯†å¯¼å›¾ï¼Œç†è§£çŸ¥è¯†ç‚¹å…³è”
- **AIé—®ç­”**ï¼šé’ˆå¯¹é‡ç‚¹éš¾ç‚¹æ³•æ¡è¿›è¡Œæ·±åº¦æé—®

#### âœï¸ ä¸»è§‚é¢˜å­¦ä¹  (${Math.round(study_schedule.daily_hours * 60 * 0.2)}åˆ†é’Ÿ - 20%æ—¶é—´)
- **æ¡ˆä¾‹åˆ†æ**ï¼šå­¦ä¹ ä¸ä»Šæ—¥å®¢è§‚é¢˜ç« èŠ‚ç›¸å…³çš„ä¸»è§‚é¢˜è§£é¢˜æ–¹æ³•
- **ç­”é¢˜æŠ€å·§**ï¼šæŒæ¡è¯¥çŸ¥è¯†ç‚¹åœ¨ä¸»è§‚é¢˜ä¸­çš„è€ƒæŸ¥æ–¹å¼
- **æ¨¡æ¿è®°å¿†**ï¼šèƒŒè¯µç›¸å…³ä¸»è§‚é¢˜ç­”é¢˜æ¨¡æ¿

#### ğŸ“ å­¦ä¹ æ€»ç»“ (5åˆ†é’Ÿ)
- æ•´ç†ä»Šæ—¥å­¦ä¹ çš„é‡ç‚¹æ³•æ¡å’ŒçŸ¥è¯†ç‚¹ç¬”è®°
- æ ‡è®°ç–‘éš¾é—®é¢˜ï¼Œå‡†å¤‡æ˜æ—¥AIé—®ç­”

### **æœ¬å‘¨å­¦ä¹ è®¡åˆ’**
æœ¬å‘¨ä¸“æ³¨å®Œæˆ${currentSubject?.subject || 'å½“å‰ç§‘ç›®'}çš„ç³»ç»Ÿå­¦ä¹ ï¼š

#### ğŸ¯ æœ¬å‘¨ç›®æ ‡
- å®Œæˆ${currentSubject?.subject || 'å½“å‰ç§‘ç›®'}çš„å…·ä½“ç« èŠ‚ï¼ˆå¿…é¡»ä»ä¸Šè¿°ç« èŠ‚æ¡†æ¶ä¸­é€‰æ‹©å…·ä½“ç« èŠ‚åç§°ï¼‰
- æŒæ¡è¯¥ç§‘ç›®çš„æ ¸å¿ƒæ³•æ¡å’Œé‡ç‚¹è€ƒç‚¹
- å®Œæˆè¯¥ç§‘ç›®80%çš„å®¢è§‚é¢˜çœŸé¢˜ç»ƒä¹ 
- æŒæ¡è¯¥ç§‘ç›®ç›¸å…³çš„ä¸»è§‚é¢˜ç­”é¢˜æŠ€å·§

#### ğŸ“… æ¯æ—¥å…·ä½“å®‰æ’ï¼ˆå¿…é¡»ä½¿ç”¨å…·ä½“ç« èŠ‚åç§°ï¼‰
**å‘¨ä¸€**: ${currentSubject?.subject || 'å½“å‰ç§‘ç›®'} - å¿…é¡»é€‰æ‹©å…·ä½“ç« èŠ‚åç§°ï¼ˆå¦‚ï¼šæ°‘æ³•æ€»åˆ™ç¼–ç¬¬ä¸€ç« è‡ªç„¶äººï¼‰
- å®¢è§‚é¢˜å­¦ä¹ : å…·ä½“æ³•æ¡ + å¯¹åº”çœŸé¢˜ç»ƒä¹  + çŸ¥è¯†å¯¼å›¾æŸ¥çœ‹
- ä¸»è§‚é¢˜å­¦ä¹ : ç›¸å…³æ¡ˆä¾‹åˆ†ææ–¹æ³•
- AIé—®ç­”é‡ç‚¹: å…·ä½“æ³•æ¡ç–‘é—®

**å‘¨äºŒ**: ${currentSubject?.subject || 'å½“å‰ç§‘ç›®'} - å¿…é¡»é€‰æ‹©å…·ä½“ç« èŠ‚åç§°ï¼ˆå¦‚ï¼šæ°‘æ³•æ€»åˆ™ç¼–ç¬¬äºŒç« æ³•äººï¼‰
- å®¢è§‚é¢˜å­¦ä¹ : å…·ä½“æ³•æ¡ + å¯¹åº”çœŸé¢˜ç»ƒä¹  + çŸ¥è¯†å¯¼å›¾æŸ¥çœ‹  
- ä¸»è§‚é¢˜å­¦ä¹ : ç›¸å…³ç­”é¢˜æ¨¡æ¿
- AIé—®ç­”é‡ç‚¹: å…·ä½“æ¦‚å¿µè¾¨æ

**å‘¨ä¸‰è‡³å‘¨${['å¤©', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'][study_schedule.weekly_days]}**: ç»§ç»­æŒ‰æ­¤æ¨¡å¼å®‰æ’ï¼Œæ¯å¤©å¿…é¡»æŒ‡å®šå…·ä½“ç« èŠ‚åç§°

#### ğŸ“Š å­¦ä¹ èµ„æºåˆ©ç”¨
- **çŸ¥è¯†å¯¼å›¾**: æ¯æ—¥å­¦ä¹ å‰å…ˆæŸ¥çœ‹${currentSubject?.subject || 'å½“å‰ç§‘ç›®'}çŸ¥è¯†å¯¼å›¾çš„å¯¹åº”ç« èŠ‚
- **AIé—®ç­”**: é’ˆå¯¹é‡ç‚¹æ³•æ¡ã€ç–‘éš¾æ¦‚å¿µè¿›è¡Œæ·±åº¦æé—®
- **çœŸé¢˜é¢˜åº“**: ç³»ç»Ÿç»ƒä¹ ${currentSubject?.subject || 'å½“å‰ç§‘ç›®'}çš„å†å¹´çœŸé¢˜ï¼ŒæŒ‰ç« èŠ‚åˆ†ç±»ç»ƒä¹ 
- **å­¦ä¹ ç¬”è®°**: å»ºç«‹${currentSubject?.subject || 'å½“å‰ç§‘ç›®'}çš„ç³»ç»Ÿç¬”è®°ï¼Œé‡ç‚¹è®°å½•æ³•æ¡è¦ç‚¹

---

**ç”Ÿæˆè¦æ±‚**ï¼š
1. âš ï¸ **å¿…é¡»æŒ‡å®šå…·ä½“çš„ç« èŠ‚ä¸“é¢˜åç§°**ï¼Œä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°ç« èŠ‚æ¡†æ¶ï¼Œå¦‚"æ°‘æ³•æ€»åˆ™ç¼–ç¬¬ä¸€ç« è‡ªç„¶äºº"è€Œä¸æ˜¯"ç¬¬ä¸€ç« "
2. âš ï¸ **å¿…é¡»ä½“ç°80%å®¢è§‚é¢˜ + 20%ä¸»è§‚é¢˜çš„æ—¶é—´åˆ†é…**
3. âš ï¸ **å¿…é¡»ä¸“æ³¨å½“å‰ç§‘ç›®**ï¼š${currentSubject?.subject || 'ç¬¬ä¸€ä¼˜å…ˆç§‘ç›®'}
4. âš ï¸ **å¿…é¡»åŒ…å«å…·ä½“çš„çœŸé¢˜ç»ƒä¹ å®‰æ’**å’ŒçŸ¥è¯†å¯¼å›¾æŸ¥çœ‹æŒ‡å¯¼
5. âš ï¸ **å¿…é¡»æä¾›å…·ä½“çš„AIé—®ç­”å»ºè®®**ï¼Œé’ˆå¯¹å…·ä½“æ³•æ¡å’Œæ¦‚å¿µ
6. âš ï¸ **ä¸¥ç¦ä½¿ç”¨æ¨¡ç³Šè¡¨è¿°**ï¼šç»ä¸èƒ½è¯´"ç›¸å…³ç« èŠ‚"ã€"å¯¹åº”ç« èŠ‚"ã€"ç¬¬Xç« "ç­‰æ¨¡ç³Šè¯æ±‡
7. âš ï¸ **æ¯æ—¥è®¡åˆ’å¿…é¡»æ˜ç¡®æŒ‡å®š**ï¼šä»Šæ—¥å­¦ä¹ "${currentSubject?.subject || 'æ°‘æ³•'}çš„XXç¼–ç¬¬Xç« XXX"çš„å…·ä½“ç« èŠ‚åç§°

è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°ç« èŠ‚æ¡†æ¶ç”Ÿæˆå…·ä½“åˆ°ç« èŠ‚åç§°çš„è¯¦ç»†å­¦ä¹ è®¡åˆ’ï¼š`

  return prompt
}

function parseAIResponse(aiResponse: string, formData: any) {
  const today = new Date()
  
  // æ›´ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†
  const overallStrategyMatch = aiResponse.match(/(?:###?\s*)?(?:\*\*)?æ€»ä½“è§„åˆ’æ€è·¯(?:\*\*)?\s*\n([\s\S]*?)(?=(?:###?\s*)?(?:\*\*)?ä»Šæ—¥å­¦ä¹ è®¡åˆ’|$)/i)
  const dailyPlanMatch = aiResponse.match(/(?:###?\s*)?(?:\*\*)?ä»Šæ—¥å­¦ä¹ è®¡åˆ’(?:\*\*)?\s*\n([\s\S]*?)(?=(?:###?\s*)?(?:\*\*)?æœ¬å‘¨å­¦ä¹ è®¡åˆ’|$)/i)
  const weeklyPlanMatch = aiResponse.match(/(?:###?\s*)?(?:\*\*)?æœ¬å‘¨å­¦ä¹ è®¡åˆ’(?:\*\*)?\s*\n([\s\S]*?)$/i)

  // æå–å†…å®¹å¹¶æ¸…ç†
  let overallStrategy = overallStrategyMatch ? overallStrategyMatch[1].trim() : ''
  let dailyPlan = dailyPlanMatch ? dailyPlanMatch[1].trim() : ''
  let weeklyPlan = weeklyPlanMatch ? weeklyPlanMatch[1].trim() : ''

  // åå¤‡è§£ææ–¹æ³•ï¼šå¦‚æœæ­£åˆ™åŒ¹é…å¤±è´¥ï¼Œå°è¯•åˆ†æ®µè§£æ
  if (!overallStrategy && !dailyPlan && !weeklyPlan) {
    const lines = aiResponse.split('\n')
    let currentSection = ''
    let tempStrategy = []
    let tempDaily = []
    let tempWeekly = []

    for (const line of lines) {
      const cleanLine = line.trim()
      
      if (cleanLine.includes('æ€»ä½“è§„åˆ’æ€è·¯') || cleanLine.includes('æ€»ä½“ç­–ç•¥')) {
        currentSection = 'strategy'
        continue
      } else if (cleanLine.includes('ä»Šæ—¥å­¦ä¹ è®¡åˆ’') || cleanLine.includes('ä»Šæ—¥è®¡åˆ’')) {
        currentSection = 'daily'
        continue
      } else if (cleanLine.includes('æœ¬å‘¨å­¦ä¹ è®¡åˆ’') || cleanLine.includes('æœ¬å‘¨è®¡åˆ’')) {
        currentSection = 'weekly'
        continue
      }

      if (currentSection === 'strategy' && cleanLine && !cleanLine.includes('ä»Šæ—¥å­¦ä¹ è®¡åˆ’') && !cleanLine.includes('æœ¬å‘¨å­¦ä¹ è®¡åˆ’')) {
        tempStrategy.push(cleanLine)
      } else if (currentSection === 'daily' && cleanLine && !cleanLine.includes('æœ¬å‘¨å­¦ä¹ è®¡åˆ’')) {
        tempDaily.push(cleanLine)
      } else if (currentSection === 'weekly' && cleanLine) {
        tempWeekly.push(cleanLine)
      }
    }

    overallStrategy = tempStrategy.join('\n').trim()
    dailyPlan = tempDaily.join('\n').trim()
    weeklyPlan = tempWeekly.join('\n').trim()
  }

  // æœ€ç»ˆæ£€æŸ¥ï¼šå¦‚æœè¿˜æ˜¯æ²¡æœ‰å†…å®¹ï¼Œå°†å®Œæ•´å“åº”ä½œä¸ºæ€»ä½“ç­–ç•¥
  if (!overallStrategy && !dailyPlan && !weeklyPlan) {
    overallStrategy = aiResponse.trim()
  }

  // æ¸…ç†å’Œæ ¼å¼åŒ–å†…å®¹
  const cleanContent = (content: string) => {
    return content
      .replace(/^#+\s*/, '') // ç§»é™¤å¼€å¤´çš„markdownæ ‡é¢˜ç¬¦å·
      .replace(/^\*\*.*?\*\*\s*\n?/, '') // ç§»é™¤å¼€å¤´çš„ç²—ä½“æ ‡é¢˜
      .trim()
  }

  // ç”Ÿæˆé»˜è®¤å†…å®¹çš„å‡½æ•°
  const generateDefaultDaily = () => {
    const hours = formData.study_schedule.daily_hours
    const firstSubject = formData.subject_order[0]?.subject || 'æ°‘æ³•'
    
    // æ ¹æ®ç§‘ç›®é€‰æ‹©å…·ä½“ç« èŠ‚
    const getSpecificChapter = (subject) => {
      const chapterMap = {
        'æ°‘æ³•': 'æ°‘æ³•æ€»åˆ™ç¼–ç¬¬ä¸€ç« è‡ªç„¶äºº',
        'åˆ‘æ³•': 'åˆ‘æ³•æ€»åˆ™ç¬¬ä¸€ç« åˆ‘æ³•çš„ä»»åŠ¡åŸºæœ¬åŸåˆ™å’Œé€‚ç”¨èŒƒå›´',
        'è¡Œæ”¿æ³•': 'è¡Œæ”¿æ³•ç¬¬ä¸€ç« è¡Œæ”¿æ³•åŸºæœ¬ç†è®º',
        'æ°‘äº‹è¯‰è®¼æ³•': 'æ°‘äº‹è¯‰è®¼æ³•ç¬¬ä¸€ç« æ€»åˆ™',
        'åˆ‘äº‹è¯‰è®¼æ³•': 'åˆ‘äº‹è¯‰è®¼æ³•ç¬¬ä¸€ç« ä»»åŠ¡å’ŒåŸºæœ¬åŸåˆ™',
        'å•†ç»æ³•': 'å…¬å¸æ³•ç¬¬ä¸€ç« æ€»åˆ™',
        'ç†è®ºæ³•': 'æ³•ç†å­¦ç¬¬ä¸€ç« æ³•å­¦å’Œæ³•ç†å­¦',
        'ä¸‰å›½æ³•': 'å›½é™…å…¬æ³•ç¬¬ä¸€ç« å¯¼è®º'
      }
      return chapterMap[subject] || 'æ°‘æ³•æ€»åˆ™ç¼–ç¬¬ä¸€ç« è‡ªç„¶äºº'
    }
    
    const specificChapter = getSpecificChapter(firstSubject)
    
    return `ğŸ“… ${new Date().toLocaleDateString()} å­¦ä¹ è®¡åˆ’ (æ€»æ—¶é•¿${hours}å°æ—¶)

ğŸ¯ ä»Šæ—¥å­¦ä¹ ç›®æ ‡ (5åˆ†é’Ÿ)
ğŸ“– çŸ¥è¯†å¯¼å›¾é¢„ä¹ ï¼šæµè§ˆ"${specificChapter}"åœ¨çŸ¥è¯†æ¡†æ¶ä¸­çš„ä½ç½®
ğŸ” æ˜ç¡®ç›®æ ‡ï¼šæ·±å…¥æŒæ¡${specificChapter}çš„æ ¸å¿ƒå†…å®¹

ğŸ“š å®¢è§‚é¢˜å­¦ä¹  (${Math.round(hours * 60 * 0.8)}åˆ†é’Ÿ - 80%æ—¶é—´)
**å…·ä½“ç« èŠ‚å­¦ä¹ ï¼š${specificChapter}**
â€¢ é‡ç‚¹æ³•æ¡æ¢³ç†ï¼šè¯¥ç« èŠ‚çš„æ ¸å¿ƒæ³•å¾‹æ¡æ–‡
â€¢ é…å¥—æ•™æç²¾è¯»ï¼šæ·±å…¥ç†è§£æ³•æ¡èƒŒæ™¯å’Œé€‚ç”¨
â€¢ çœŸé¢˜ç»ƒä¹ ï¼šç»ƒä¹ ${specificChapter}å¯¹åº”çš„å†å¹´å®¢è§‚é¢˜çœŸé¢˜
â€¢ çŸ¥è¯†å¯¼å›¾ï¼šæŸ¥çœ‹è¯¥ç« èŠ‚åœ¨æ•´ä½“çŸ¥è¯†ä½“ç³»ä¸­çš„ä½ç½®
â€¢ AIé—®ç­”ï¼šé’ˆå¯¹é‡éš¾ç‚¹æ³•æ¡è¿›è¡Œæ·±åº¦æé—®

âœï¸ ä¸»è§‚é¢˜å­¦ä¹  (${Math.round(hours * 60 * 0.2)}åˆ†é’Ÿ - 20%æ—¶é—´)
â€¢ æ¡ˆä¾‹åˆ†æï¼šå­¦ä¹ ä¸${specificChapter}ç›¸å…³çš„ä¸»è§‚é¢˜è§£é¢˜æ–¹æ³•
â€¢ ç­”é¢˜æŠ€å·§ï¼šæŒæ¡è¯¥çŸ¥è¯†ç‚¹åœ¨ä¸»è§‚é¢˜ä¸­çš„è€ƒæŸ¥æ–¹å¼
â€¢ æ¨¡æ¿è®°å¿†ï¼šèƒŒè¯µç›¸å…³ä¸»è§‚é¢˜ç­”é¢˜æ¨¡æ¿

ğŸ“ å­¦ä¹ æ€»ç»“ (5åˆ†é’Ÿ)
â€¢ æ•´ç†${specificChapter}çš„é‡ç‚¹æ³•æ¡å’ŒçŸ¥è¯†ç‚¹ç¬”è®°
â€¢ æ ‡è®°ç–‘éš¾é—®é¢˜ï¼Œå‡†å¤‡æ˜æ—¥AIé—®ç­”`
  }

  const generateDefaultWeekly = () => {
    const days = formData.study_schedule.weekly_days
    const hours = formData.study_schedule.daily_hours
    const firstSubject = formData.subject_order[0]?.subject || 'æ°‘æ³•'
    
    // æ ¹æ®ç§‘ç›®è·å–å…·ä½“ç« èŠ‚åˆ—è¡¨
    const getWeeklyChapters = (subject) => {
      const chapterMap = {
        'æ°‘æ³•': [
          'æ°‘æ³•æ€»åˆ™ç¼–ç¬¬ä¸€ç« è‡ªç„¶äºº',
          'æ°‘æ³•æ€»åˆ™ç¼–ç¬¬äºŒç« æ³•äºº', 
          'æ°‘æ³•æ€»åˆ™ç¼–ç¬¬ä¸‰ç« éæ³•äººç»„ç»‡',
          'æ°‘æ³•æ€»åˆ™ç¼–ç¬¬å››ç« æ°‘äº‹æƒåˆ©',
          'æ°‘æ³•æ€»åˆ™ç¼–ç¬¬äº”ç« æ°‘äº‹æ³•å¾‹è¡Œä¸º'
        ],
        'åˆ‘æ³•': [
          'åˆ‘æ³•æ€»åˆ™ç¬¬ä¸€ç« åˆ‘æ³•çš„ä»»åŠ¡åŸºæœ¬åŸåˆ™å’Œé€‚ç”¨èŒƒå›´',
          'åˆ‘æ³•æ€»åˆ™ç¬¬äºŒç« çŠ¯ç½ª',
          'åˆ‘æ³•æ€»åˆ™ç¬¬ä¸‰ç« åˆ‘ç½š',
          'åˆ‘æ³•åˆ†åˆ™ç¬¬ä¸€ç« å±å®³å›½å®¶å®‰å…¨ç½ª',
          'åˆ‘æ³•åˆ†åˆ™ç¬¬äºŒç« å±å®³å…¬å…±å®‰å…¨ç½ª'
        ],
        'è¡Œæ”¿æ³•': [
          'è¡Œæ”¿æ³•ç¬¬ä¸€ç« è¡Œæ”¿æ³•åŸºæœ¬ç†è®º',
          'è¡Œæ”¿æ³•ç¬¬äºŒç« è¡Œæ”¿æ³•ä¸»ä½“', 
          'è¡Œæ”¿æ³•ç¬¬ä¸‰ç« è¡Œæ”¿è¡Œä¸º',
          'è¡Œæ”¿æ³•ç¬¬å››ç« è¡Œæ”¿ç¨‹åº',
          'è¡Œæ”¿æ³•ç¬¬äº”ç« è¡Œæ”¿å¤è®®'
        ]
      }
      return chapterMap[subject] || chapterMap['æ°‘æ³•']
    }
    
    const weeklyChapters = getWeeklyChapters(firstSubject)
    
    return `ğŸ—“ï¸ æœ¬å‘¨å­¦ä¹ è®¡åˆ’

ğŸ¯ æœ¬å‘¨ç›®æ ‡ï¼šå®Œæˆ${firstSubject}æ ¸å¿ƒç« èŠ‚ç³»ç»Ÿå­¦ä¹ 
â° é¢„è®¡æ€»æ—¶é•¿ï¼š${hours * days}å°æ—¶ï¼ˆæ¯å¤©${hours}å°æ—¶ Ã— ${days}å¤©ï¼‰

ğŸ“š æ¯æ—¥å…·ä½“å®‰æ’ï¼š
${Array.from({length: days}, (_, i) => {
  const dayNames = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥']
  const specificChapter = weeklyChapters[i] || weeklyChapters[0]
  return `
ğŸ“– ${dayNames[i]}ï¼š${specificChapter}
â€¢ å®¢è§‚é¢˜å­¦ä¹ ï¼ˆ${Math.round(hours * 60 * 0.8)}åˆ†é’Ÿï¼‰ï¼š
  - é‡ç‚¹æ³•æ¡æ¢³ç†å’Œç†è§£
  - é…å¥—æ•™æç²¾è¯»
  - çœŸé¢˜ç»ƒä¹ ï¼š${specificChapter}ç›¸å…³å®¢è§‚é¢˜
  - çŸ¥è¯†å¯¼å›¾æŸ¥çœ‹ï¼šè¯¥ç« èŠ‚çŸ¥è¯†æ¡†æ¶
â€¢ ä¸»è§‚é¢˜å­¦ä¹ ï¼ˆ${Math.round(hours * 60 * 0.2)}åˆ†é’Ÿï¼‰ï¼š
  - æ¡ˆä¾‹åˆ†ææ–¹æ³•
  - ç­”é¢˜æŠ€å·§æŒæ¡
â€¢ AIé—®ç­”ï¼šé’ˆå¯¹è¯¥ç« èŠ‚é‡éš¾ç‚¹æ³•æ¡æ·±åº¦æé—®`
}).join('\n')}

ğŸ’¡ æœ¬å‘¨å­¦ä¹ è¦ç‚¹ï¼š
â€¢ ç³»ç»ŸæŒæ¡${firstSubject}çš„åŸºç¡€ç†è®ºæ¡†æ¶
â€¢ å……åˆ†åˆ©ç”¨çŸ¥è¯†å¯¼å›¾ç†è§£ç« èŠ‚é—´çš„é€»è¾‘å…³è”
â€¢ é€šè¿‡AIé—®ç­”æ·±åº¦è§£ææ¯ç« çš„é‡éš¾ç‚¹æ³•æ¡
â€¢ å»ºç«‹å®Œæ•´çš„${firstSubject}å­¦ä¹ ç¬”è®°ä½“ç³»`
  }

  return {
    overallStrategy: cleanContent(overallStrategy) || `ğŸ¯ å­¦ä¹ è®¡åˆ’æ€»ä½“ç­–ç•¥

ğŸ“Š å½“å‰è¿›åº¦åˆ†æï¼š
â€¢ å½“å‰é‡ç‚¹ç§‘ç›®ï¼š${formData.subject_order[0]?.subject || 'æ°‘æ³•'}
â€¢ å­¦ä¹ æ–¹å¼ï¼šéµå¾ª80%å®¢è§‚é¢˜ + 20%ä¸»è§‚é¢˜çš„ç§‘å­¦é…æ¯”
â€¢ æ—¶é—´å®‰æ’ï¼šæ¯æ—¥${formData.study_schedule.daily_hours}å°æ—¶ï¼Œæ¯å‘¨${formData.study_schedule.weekly_days}å¤©

ğŸ¯ å…·ä½“å­¦ä¹ ç›®æ ‡ï¼š
â€¢ ä¸“æ³¨å®Œæˆ${formData.subject_order[0]?.subject || 'æ°‘æ³•'}çš„ç³»ç»Ÿå­¦ä¹ ï¼Œä¸€ä¸ªç§‘ç›®å®Œå…¨æŒæ¡åå†è¿›è¡Œä¸‹ä¸€ä¸ª
â€¢ æ·±å…¥æŒæ¡æ¯ä¸ªå…·ä½“ç« èŠ‚çš„æ ¸å¿ƒæ³•æ¡å’Œé€‚ç”¨è¦ç‚¹
â€¢ é€šè¿‡çŸ¥è¯†å¯¼å›¾å»ºç«‹ç« èŠ‚é—´çš„é€»è¾‘å…³è”
â€¢ å……åˆ†åˆ©ç”¨AIé—®ç­”åŠŸèƒ½è§£å†³é‡éš¾ç‚¹æ³•æ¡ç–‘é—®

ğŸ“š ç§‘å­¦å­¦ä¹ ç­–ç•¥ï¼š
â€¢ ç« èŠ‚åŒ–å­¦ä¹ ï¼šä¸¥æ ¼æŒ‰ç…§å…·ä½“ç« èŠ‚åç§°è¿›è¡Œç³»ç»Ÿå­¦ä¹ 
â€¢ ç†è®ºå®è·µç»“åˆï¼šå­¦å®Œç†è®ºç«‹å³è¿›è¡Œå¯¹åº”çœŸé¢˜ç»ƒä¹ 
â€¢ çŸ¥è¯†ä½“ç³»åŒ–ï¼šé€šè¿‡çŸ¥è¯†å¯¼å›¾ç†è§£ç« èŠ‚åœ¨æ•´ä½“æ¡†æ¶ä¸­çš„ä½ç½®
â€¢ é—®é¢˜å¯¼å‘ï¼šé€šè¿‡AIé—®ç­”æ·±åº¦è§£æç–‘éš¾æ¦‚å¿µå’Œæ³•æ¡é€‚ç”¨`,
    
    dailyPlan: cleanContent(dailyPlan) || generateDefaultDaily(),
    
    weeklyPlan: cleanContent(weeklyPlan) || generateDefaultWeekly(),
    
    generatedAt: today.toISOString(),
    settings: {
      dailyHours: formData.study_schedule.daily_hours,
      weeklyDays: formData.study_schedule.weekly_days,
      subjects: formData.subject_order.map((item: any) => item.subject)
    }
  }
}