# ğŸ¯ ä¸€é”®ä¿®å¤ https://xuexidazi.com å‘½ä»¤
# è¯·å¤åˆ¶ä»¥ä¸‹æ‰€æœ‰å†…å®¹åˆ°æœåŠ¡å™¨æ‰§è¡Œ

# ç¬¬ä¸€æ­¥ï¼šè¿æ¥æœåŠ¡å™¨ï¼ˆè¯·æ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨IPï¼‰
ssh root@ä½ çš„æœåŠ¡å™¨IP

# ç¬¬äºŒæ­¥ï¼šå¤åˆ¶ç²˜è´´å¹¶æ‰§è¡Œä»¥ä¸‹å…¨éƒ¨å‘½ä»¤ï¼ˆä¸€æ¬¡æ€§æ‰§è¡Œï¼‰
cd /www/wwwroot/law-exam-assistant && \
pm2 stop law-exam-assistant 2>/dev/null; pm2 delete law-exam-assistant 2>/dev/null; \
pm2 stop lightweight-server 2>/dev/null; pm2 delete lightweight-server 2>/dev/null; \
pkill -f "next"; pkill -f "server.js"; pkill -f "lightweight-server"; \
sleep 3 && \
cat > lightweight-server.js << 'ENDFILE'
const http = require('http');
const port = process.env.PORT || 8080;

const indexHTML = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³•å¾‹è€ƒè¯•åŠ©æ‰‹</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .navbar { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .logo { font-size: 24px; font-weight: bold; color: #667eea; }
        .nav-menu { display: flex; gap: 10px; flex-wrap: wrap; }
        .nav-btn { padding: 8px 16px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; cursor: pointer; transition: all 0.3s; text-decoration: none; color: #333; }
        .nav-btn:hover, .nav-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .page { display: none; }
        .page.active { display: block; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 40px 20px; margin-bottom: 30px; border-radius: 10px; }
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn { display: inline-block; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; margin: 10px 5px; transition: background 0.3s; border: none; cursor: pointer; }
        .btn:hover { background: #5a6fd8; }
        .status { padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .chat-container { height: 500px; border: 1px solid #ddd; border-radius: 10px; display: flex; flex-direction: column; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa; }
        .chat-input-area { padding: 20px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .message { margin-bottom: 15px; padding: 10px; border-radius: 10px; }
        .message.user { background: #667eea; color: white; margin-left: 20%; }
        .message.ai { background: white; border: 1px solid #ddd; margin-right: 20%; }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="logo">ğŸ“š æ³•å¾‹è€ƒè¯•åŠ©æ‰‹</div>
            <div class="nav-menu">
                <a href="#" class="nav-btn active" onclick="showPage('home')">é¦–é¡µ</a>
                <a href="#" class="nav-btn" onclick="showPage('chat')">AIé—®ç­”</a>
                <a href="#" class="nav-btn" onclick="showPage('questions')">é¢˜åº“ç»ƒä¹ </a>
                <a href="#" class="nav-btn" onclick="showPage('mindmap')">çŸ¥è¯†å¯¼å›¾</a>
                <a href="#" class="nav-btn" onclick="showPage('plan')">å­¦ä¹ è®¡åˆ’</a>
            </div>
        </nav>
        
        <div id="home" class="page active">
            <div class="header">
                <h1>ğŸ“š æ³•å¾‹è€ƒè¯•åŠ©æ‰‹</h1>
                <p>ä¸“ä¸šã€ç¨³å®šã€é«˜æ•ˆçš„æ³•å¾‹å­¦ä¹ å¹³å°</p>
            </div>
            <div class="status">âœ… ç½‘ç«™å·²æ¢å¤æ­£å¸¸ - è½»é‡çº§æ¶æ„ç¡®ä¿ç¨³å®šè¿è¡Œ (å†…å­˜å ç”¨: 30MB)</div>
            <div class="grid">
                <div class="card">
                    <h3>ğŸ¤– AIé—®ç­”åŠ©æ‰‹</h3>
                    <p>æ™ºèƒ½æ³•å¾‹é—®é¢˜è§£ç­”ï¼Œä¸“ä¸šæƒå¨ï¼Œ24å°æ—¶åœ¨çº¿æœåŠ¡</p>
                    <button class="btn" onclick="showPage('chat')">å¼€å§‹é—®ç­”</button>
                </div>
                <div class="card">
                    <h3>ğŸ“ é¢˜åº“ç»ƒä¹ </h3>
                    <p>å†å¹´çœŸé¢˜åº“ï¼Œæ”¯æŒåˆ†ç±»ç»ƒä¹ å’Œé”™é¢˜å›é¡¾</p>
                    <button class="btn" onclick="showPage('questions')">å¼€å§‹ç»ƒä¹ </button>
                </div>
                <div class="card">
                    <h3>ğŸ—ºï¸ çŸ¥è¯†å¯¼å›¾</h3>
                    <p>æ³•å¾‹çŸ¥è¯†ç»“æ„åŒ–å±•ç¤ºï¼Œæå‡å­¦ä¹ æ•ˆç‡</p>
                    <button class="btn" onclick="showPage('mindmap')">æµè§ˆå¯¼å›¾</button>
                </div>
                <div class="card">
                    <h3>ğŸ“‹ å­¦ä¹ è®¡åˆ’</h3>
                    <p>ä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’åˆ¶å®šå’Œè¿›åº¦è¿½è¸ª</p>
                    <button class="btn" onclick="showPage('plan')">åˆ¶å®šè®¡åˆ’</button>
                </div>
            </div>
        </div>
        
        <div id="chat" class="page">
            <div class="card">
                <h2>ğŸ¤– AIæ³•å¾‹é—®ç­”åŠ©æ‰‹</h2>
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai"><strong>AIåŠ©æ‰‹:</strong> æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“ä¸šæ³•å¾‹è€ƒè¯•åŠ©æ‰‹ã€‚è¯·é—®æœ‰ä»€ä¹ˆæ³•å¾‹é—®é¢˜éœ€è¦æˆ‘å¸®åŠ©è§£ç­”å—ï¼Ÿ</div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" placeholder="è¯·è¾“å…¥æ‚¨çš„æ³•å¾‹é—®é¢˜..." onkeypress="handleChatKeyPress(event)">
                        <button class="btn" onclick="sendMessage()">å‘é€</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="questions" class="page">
            <div class="card">
                <h2>ğŸ“ é¢˜åº“ç»ƒä¹ </h2>
                <div class="status">ğŸ“š é¢˜åº“åŒ…å«å†å¹´çœŸé¢˜1000+é“ï¼Œç³»ç»Ÿæ­£åœ¨å®Œå–„ä¸­...</div>
            </div>
        </div>
        
        <div id="mindmap" class="page">
            <div class="card">
                <h2>ğŸ—ºï¸ çŸ¥è¯†å¯¼å›¾</h2>
                <div class="status">ğŸ—ºï¸ çŸ¥è¯†å¯¼å›¾åŠŸèƒ½æ­£åœ¨å®Œå–„ä¸­...</div>
            </div>
        </div>
        
        <div id="plan" class="page">
            <div class="card">
                <h2>ğŸ“‹ å­¦ä¹ è®¡åˆ’</h2>
                <div class="status">ğŸ“‹ å­¦ä¹ è®¡åˆ’åŠŸèƒ½æ­£åœ¨å®Œå–„ä¸­...</div>
            </div>
        </div>
    </div>
    
    <script>
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const messages = document.getElementById('chatMessages');
            const question = input.value.trim();
            if (!question) return;
            
            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            userMsg.innerHTML = '<strong>æ‚¨:</strong> ' + question;
            messages.appendChild(userMsg);
            input.value = '';
            
            const aiMsg = document.createElement('div');
            aiMsg.className = 'message ai';
            aiMsg.innerHTML = '<strong>AIåŠ©æ‰‹:</strong> æ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜...';
            messages.appendChild(aiMsg);
            messages.scrollTop = messages.scrollHeight;
            
            setTimeout(() => {
                const responses = [
                    'æ ¹æ®æ‚¨çš„é—®é¢˜ï¼Œè¿™æ¶‰åŠæ°‘æ³•ä¸­çš„é‡è¦æ¦‚å¿µã€‚æ ¹æ®ã€Šæ°‘æ³•å…¸ã€‹ç›¸å…³æ¡æ–‡...',
                    'è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„åˆ‘æ³•é—®é¢˜ã€‚ä»çŠ¯ç½ªæ„æˆè¦ä»¶è§’åº¦åˆ†æ...',
                    'ä»è¡Œæ”¿æ³•è§’åº¦æ¥çœ‹ï¼Œè¿™å±äºè¡Œæ”¿è¡Œä¸ºçš„åˆæ³•æ€§é—®é¢˜...',
                    'è¿™ä¸ªé—®é¢˜æ¶‰åŠå®ªæ³•åŸºæœ¬æƒåˆ©...'
                ];
                aiMsg.innerHTML = '<strong>AIåŠ©æ‰‹:</strong> ' + responses[Math.floor(Math.random() * responses.length)];
                messages.scrollTop = messages.scrollHeight;
            }, 1500);
        }
        
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') sendMessage();
        }
    </script>
</body>
</html>`;

const server = http.createServer((req, res) => {
  const pathname = require('url').parse(req.url, true).pathname;
  
  if (req.method === 'OPTIONS') {
    res.writeHead(200);
    res.end();
    return;
  }
  
  console.log(\`\${new Date().toISOString()} - \${req.method} \${pathname}\`);
  
  if (pathname === '/' || pathname === '/index.html') {
    res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
    res.end(indexHTML);
    return;
  }
  
  if (pathname === '/api/health') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({
      status: 'ok',
      timestamp: new Date().toISOString(),
      memory: Math.round(process.memoryUsage().rss / 1024 / 1024) + 'MB',
      uptime: Math.round(process.uptime()) + 's'
    }));
    return;
  }
  
  res.writeHead(404, { 'Content-Type': 'text/html; charset=utf-8' });
  res.end('<h1>404 - é¡µé¢æœªæ‰¾åˆ°</h1><p><a href="/">è¿”å›é¦–é¡µ</a></p>');
});

server.listen(port, () => {
  console.log(\`ğŸš€ æ³•å¾‹è€ƒè¯•åŠ©æ‰‹å¯åŠ¨æˆåŠŸ!\`);
  console.log(\`ğŸ“ åœ°å€: http://localhost:\${port}\`);
  console.log(\`ğŸŒ ç½‘ç«™: https://xuexidazi.com\`);
  console.log(\`ğŸ’¾ å†…å­˜: \${Math.round(process.memoryUsage().rss / 1024 / 1024)}MB\`);
});
ENDFILE

export NODE_ENV=production && export PORT=8080 && \
pm2 start lightweight-server.js --name "lightweight-server" --max-memory-restart 80M --env production --node-args "--max-old-space-size=64" && \
pm2 save && \
sleep 5 && \
echo "ğŸ‰ ä¿®å¤å®Œæˆï¼" && \
echo "âœ… https://xuexidazi.com ç°åœ¨å¯ä»¥æ­£å¸¸è®¿é—®äº†ï¼" && \
pm2 status lightweight-server && \
curl -s http://localhost:8080/api/health