<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试题库页面修复</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            margin-bottom: 15px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 10px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <h1>测试题库页面修复</h1>

    <div class="test-section">
        <h2>1. 测试正常题目列表加载</h2>
        <button onclick="testNormalQuestions()">测试正常加载</button>
        <div id="normal-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. 测试AI关键词跳转</h2>
        <button onclick="testAIKeywords()">测试AI关键词</button>
        <div id="ai-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. 测试搜索功能</h2>
        <button onclick="testSearch()">测试搜索</button>
        <div id="search-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. 测试关键词并集搜索</h2>
        <button onclick="testUnionSearch()">测试并集搜索</button>
        <div id="union-result" class="result"></div>
    </div>

    <script>
        // 测试正常题目列表加载
        async function testNormalQuestions() {
            const resultDiv = document.getElementById('normal-result');
            resultDiv.textContent = '正在测试正常题目列表加载...';
            
            try {
                const response = await fetch('/api/exams/questions?subject=民法&page=1&limit=10');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<strong>✓ 正常加载成功</strong>\n`;
                    resultDiv.innerHTML += `找到 ${data.data.pagination.total} 道题目\n`;
                    resultDiv.innerHTML += `当前页显示 ${data.data.questions.length} 道题目\n\n`;
                    resultDiv.innerHTML += `<strong>示例题目：</strong>\n`;
                    data.data.questions.slice(0, 3).forEach((q, i) => {
                        resultDiv.innerHTML += `${i+1}. [${q.subject}] ${q.content ? q.content.substring(0, 50) : q.question_text.substring(0, 50)}...\n`;
                    });
                    resultDiv.innerHTML += `\n<span class="status success">✓ 测试通过</span>`;
                } else {
                    resultDiv.innerHTML = `<strong>✗ 加载失败</strong>\n${data.message || '未知错误'}\n<span class="status error">✗ 测试失败</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<strong>错误：</strong>${error.message}\n<span class="status error">✗ 请求失败</span>`;
            }
        }
        
        // 测试AI关键词跳转
        function testAIKeywords() {
            const resultDiv = document.getElementById('ai-result');
            
            // 模拟AI聊天跳转的URL参数
            const params = new URLSearchParams({
                subject: '刑法',
                keywords: '故意杀人,正当防卫,紧急避险',
                source: 'ai-chat'
            });
            
            const url = `/question-bank?${params.toString()}`;
            
            resultDiv.innerHTML = `<strong>模拟AI跳转URL：</strong>\n${url}\n\n`;
            resultDiv.innerHTML += `<strong>参数解析：</strong>\n`;
            resultDiv.innerHTML += `科目: 刑法\n`;
            resultDiv.innerHTML += `关键词: 故意杀人、正当防卫、紧急避险\n`;
            resultDiv.innerHTML += `来源: AI聊天\n\n`;
            resultDiv.innerHTML += `<a href="${url}" target="_blank" style="color: #4CAF50;">点击在新标签页打开测试</a>\n`;
            resultDiv.innerHTML += `\n<span class="status info">ℹ 请查看控制台查看关键词搜索日志</span>`;
        }
        
        // 测试搜索功能
        async function testSearch() {
            const resultDiv = document.getElementById('search-result');
            resultDiv.textContent = '正在测试搜索功能...';
            
            try {
                const response = await fetch('/api/exams/questions?subject=民法&search=合同&page=1&limit=10');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<strong>✓ 搜索成功</strong>\n`;
                    resultDiv.innerHTML += `搜索 "合同" 找到 ${data.data.pagination.total} 道题目\n`;
                    resultDiv.innerHTML += `当前页显示 ${data.data.questions.length} 道题目\n`;
                    resultDiv.innerHTML += `\n<span class="status success">✓ 搜索功能正常</span>`;
                } else {
                    resultDiv.innerHTML = `<strong>✗ 搜索失败</strong>\n${data.message || '未知错误'}\n<span class="status error">✗ 测试失败</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<strong>错误：</strong>${error.message}\n<span class="status error">✗ 请求失败</span>`;
            }
        }
        
        // 测试关键词并集搜索
        async function testUnionSearch() {
            const resultDiv = document.getElementById('union-result');
            resultDiv.textContent = '正在测试关键词并集搜索...';
            
            const keywords = ['买卖', '租赁', '借贷'];
            const results = [];
            const allIds = new Set();
            
            try {
                resultDiv.innerHTML = `<strong>测试多关键词并集搜索：</strong>\n关键词: ${keywords.join('、')}\n\n`;
                
                for (const keyword of keywords) {
                    const response = await fetch(`/api/exams/questions?subject=民法&search=${encodeURIComponent(keyword)}&page=1&limit=100`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const count = data.data.questions.length;
                        results.push({ keyword, count, questions: data.data.questions });
                        data.data.questions.forEach(q => allIds.add(q.id));
                        resultDiv.innerHTML += `"${keyword}" 找到 ${count} 道题目\n`;
                    }
                }
                
                resultDiv.innerHTML += `\n<strong>并集结果：</strong>\n`;
                resultDiv.innerHTML += `总共找到 ${allIds.size} 道不重复的题目\n`;
                
                // 计算重复的题目数
                const totalBeforeUnion = results.reduce((sum, r) => sum + r.count, 0);
                const duplicates = totalBeforeUnion - allIds.size;
                resultDiv.innerHTML += `去重前总数: ${totalBeforeUnion}\n`;
                resultDiv.innerHTML += `重复题目数: ${duplicates}\n`;
                
                resultDiv.innerHTML += `\n<span class="status success">✓ 并集搜索测试完成</span>`;
            } catch (error) {
                resultDiv.innerHTML += `<strong>错误：</strong>${error.message}\n<span class="status error">✗ 测试失败</span>`;
            }
        }
    </script>
</body>
</html>