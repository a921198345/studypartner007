<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>测试会话流程</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>答题会话流程测试</h1>
    
    <div class="section">
        <h2>1. 检查当前会话</h2>
        <button onclick="checkCurrentSession()">检查当前会话</button>
        <div id="currentSession" class="log"></div>
    </div>
    
    <div class="section">
        <h2>2. 创建新会话</h2>
        <button onclick="createNewSession()">创建新会话</button>
        <div id="createResult" class="log"></div>
    </div>
    
    <div class="section">
        <h2>3. 提交答案测试</h2>
        <label>题目ID: <input type="number" id="questionId" value="1"></label>
        <label>答案: <input type="text" id="answer" value="A" maxlength="4"></label>
        <button onclick="submitAnswer()">提交答案</button>
        <div id="submitResult" class="log"></div>
    </div>
    
    <div class="section">
        <h2>4. 检查会话更新</h2>
        <button onclick="checkSessionUpdate()">检查会话状态</button>
        <div id="sessionStatus" class="log"></div>
    </div>

    <script>
        // 获取客户端会话ID
        function getClientSessionId() {
            let sessionId = localStorage.getItem('client_session_id');
            if (!sessionId) {
                sessionId = `client_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('client_session_id', sessionId);
            }
            return sessionId;
        }

        // 添加客户端会话头
        function addClientSessionHeader(headers = {}) {
            const sessionId = getClientSessionId();
            return {
                ...headers,
                'X-Client-Session-Id': sessionId
            };
        }

        // 检查当前会话
        function checkCurrentSession() {
            const currentSession = localStorage.getItem('currentAnswerSession');
            const clientSessionId = getClientSessionId();
            
            let html = `<strong>客户端会话ID:</strong> ${clientSessionId}<br>`;
            
            if (currentSession) {
                try {
                    const session = JSON.parse(currentSession);
                    html += `<strong>当前答题会话:</strong><br>`;
                    html += `- 会话ID: ${session.sessionId}<br>`;
                    html += `- 开始时间: ${session.startTime}<br>`;
                    html += `- 已答题数: ${session.questionsAnswered}<br>`;
                    html += `- 答对数: ${session.correctCount}<br>`;
                } catch (e) {
                    html += `<span class="error">解析会话失败: ${e.message}</span>`;
                }
            } else {
                html += `<span class="error">没有当前会话</span>`;
            }
            
            document.getElementById('currentSession').innerHTML = html;
        }

        // 创建新会话
        async function createNewSession() {
            try {
                const response = await fetch('/api/exams/sessions', {
                    method: 'POST',
                    headers: addClientSessionHeader({
                        'Content-Type': 'application/json',
                    }),
                    body: JSON.stringify({
                        filters: { subject: 'all' },
                        totalQuestions: 100,
                        source: 'all'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // 创建本地会话
                    const localSession = {
                        sessionId: result.data.sessionId,
                        startTime: new Date().toISOString(),
                        questionsAnswered: 0,
                        correctCount: 0,
                        totalQuestions: 100,
                        source: 'all',
                        filters: { subject: 'all' }
                    };
                    
                    localStorage.setItem('currentAnswerSession', JSON.stringify(localSession));
                    
                    document.getElementById('createResult').innerHTML = 
                        `<span class="success">会话创建成功！<br>会话ID: ${result.data.sessionId}</span>`;
                } else {
                    document.getElementById('createResult').innerHTML = 
                        `<span class="error">创建失败: ${result.message}</span>`;
                }
            } catch (error) {
                document.getElementById('createResult').innerHTML = 
                    `<span class="error">请求失败: ${error.message}</span>`;
            }
        }

        // 提交答案
        async function submitAnswer() {
            const questionId = document.getElementById('questionId').value;
            const answer = document.getElementById('answer').value;
            
            // 获取当前会话ID
            let sessionId = null;
            const currentSessionStr = localStorage.getItem('currentAnswerSession');
            if (currentSessionStr) {
                try {
                    const currentSession = JSON.parse(currentSessionStr);
                    sessionId = currentSession.sessionId;
                } catch (e) {
                    console.error('解析会话失败:', e);
                }
            }
            
            if (!sessionId) {
                document.getElementById('submitResult').innerHTML = 
                    `<span class="error">没有当前会话，请先创建会话</span>`;
                return;
            }
            
            try {
                console.log('提交参数:', { questionId, answer, sessionId });
                
                const response = await fetch(`/api/exams/questions/${questionId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        submitted_answer: answer,
                        session_id: sessionId
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('submitResult').innerHTML = 
                        `<span class="success">提交成功！<br>` +
                        `是否正确: ${result.data.is_correct ? '✓' : '✗'}<br>` +
                        `正确答案: ${result.data.correct_answer}</span>`;
                        
                    // 更新本地会话统计
                    if (currentSessionStr) {
                        const session = JSON.parse(currentSessionStr);
                        session.questionsAnswered++;
                        if (result.data.is_correct) {
                            session.correctCount++;
                        }
                        localStorage.setItem('currentAnswerSession', JSON.stringify(session));
                    }
                } else {
                    document.getElementById('submitResult').innerHTML = 
                        `<span class="error">提交失败: ${result.message}</span>`;
                }
            } catch (error) {
                document.getElementById('submitResult').innerHTML = 
                    `<span class="error">请求失败: ${error.message}</span>`;
            }
        }

        // 检查会话更新
        async function checkSessionUpdate() {
            try {
                const response = await fetch('/api/exams/sessions', {
                    headers: addClientSessionHeader()
                });

                const result = await response.json();
                
                if (result.success && result.data.sessions.length > 0) {
                    let html = '<strong>数据库中的会话:</strong><br>';
                    result.data.sessions.forEach(session => {
                        html += `会话 ${session.session_id}: 已答 ${session.questions_answered} 题，答对 ${session.correct_count} 题<br>`;
                    });
                    document.getElementById('sessionStatus').innerHTML = html;
                } else {
                    document.getElementById('sessionStatus').innerHTML = 
                        `<span class="error">没有找到会话记录</span>`;
                }
            } catch (error) {
                document.getElementById('sessionStatus').innerHTML = 
                    `<span class="error">请求失败: ${error.message}</span>`;
            }
        }

        // 页面加载时检查
        window.onload = function() {
            checkCurrentSession();
        };
    </script>
</body>
</html>